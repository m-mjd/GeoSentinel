<!DOCTYPE html>
<html lang="en">
<!-- templates/map.html -->


<head>
    <meta property="og:image" content="https://haybnz.web.app/logo.png" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HayOS - Advanced Geo Tracker</title>
    <link rel="icon" href="https://haybnz.web.app/logo.png" type="image/x-icon">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const startTime = Date.now();
            const username = document.cookie.split('; ').find(row => row.startsWith('username='))?.split('=')[1] || 'anonymous';
            const page = window.location.pathname;

            function sendActivity(event, details = '') {
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                fetch('/log-activity', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        page: page,
                        event: event,
                        details: details,
                        duration: duration
                    })
                });
            }

            // Advanced Search Handler (improved: try multiple flight query params)
            const advancedSearch = document.getElementById('advanced-search');
            if (advancedSearch) {
                advancedSearch.addEventListener('keypress', async (e) => {
                    if (e.key !== 'Enter') return;
                    const typeSelect = document.getElementById('search-type');
                    const type = typeSelect ? typeSelect.value : 'hex';
                    const query = e.target.value.trim();
                    if (!query) return;

                    // Ensure flight tracker is enabled if searching for flights
                    if (!flightEnabled) {
                        const flightToggle = document.getElementById('flight-toggle');
                        if (flightToggle) {
                            flightToggle.checked = true;
                            flightToggle.dispatchEvent(new Event('change'));
                        }
                    }

                    // Try a list of possible query parameter names the server might accept
                    const paramNames = ['q', 'icao', 'hex', 'callsign', 'call', 'reg', 'registration', 'type'];
                    let found = false;
                    try {
                        for (const p of paramNames) {
                            try {
                                const url = `/api/geo/flights?${p}=${encodeURIComponent(query)}`;
                                const res = await axios.get(url);
                                const data = res.data;
                                if (data && Array.isArray(data) && data.length > 0) {
                                    const f = data[0];
                                    map.setView([f.lat, f.long], 10);
                                    updateFlightTracker();
                                    setTimeout(() => {
                                        if (flightMarkers[f.icao24]) flightMarkers[f.icao24].openPopup();
                                    }, 800);
                                    found = true;
                                    break;
                                }
                            } catch (innerErr) {
                                // try next param if this one fails
                                console.debug('Flight query attempt failed for param', p, innerErr);
                            }
                        }

                        if (!found) {
                            // Some APIs expect uppercase ICAO hex - try that specifically
                            if (query.length >= 6) {
                                const qUpper = query.toUpperCase();
                                try {
                                    const res2 = await axios.get(`/api/geo/flights?icao=${encodeURIComponent(qUpper)}`);
                                    if (res2.data && Array.isArray(res2.data) && res2.data.length > 0) {
                                        const f = res2.data[0];
                                        map.setView([f.lat, f.long], 10);
                                        updateFlightTracker();
                                        setTimeout(() => {
                                            if (flightMarkers[f.icao24]) flightMarkers[f.icao24].openPopup();
                                        }, 800);
                                        found = true;
                                    }
                                } catch (e) { /* ignore */ }
                            }
                        }

                        // If still not found and this looks like a location search, fallback to nominatim
                        if (!found && type !== 'hex' && type !== 'call' && type !== 'reg' && type !== 'type') {
                            try {
                                const response = await axios.get(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json`);
                                if (response.data && response.data.length > 0) {
                                    const { lat, lon } = response.data[0];
                                    map.setView([lat, lon], 12);
                                }
                            } catch (nomErr) {
                                console.error('Nominatim error', nomErr);
                            }
                        }

                        if (!found) {
                            const listEl = document.getElementById('flights-active-list');
                            if (listEl) listEl.innerHTML = `<div class="log-entry warn" style="padding: 5px;">NO_MATCH_FOR: ${query}</div>`;
                        }
                    } catch (err) {
                        console.error("Search error", err);
                    }
                });
            }

            // Log page view
            sendActivity('page_view');

            // Log clicks
            document.addEventListener('click', function (e) {
                const target = e.target.closest('button, a, input[type="submit"]');
                if (target) {
                    const text = (target.innerText || target.value || target.href || '').substring(0, 100);
                    sendActivity('click', text);
                }
            });

            // Log before unload (time spent)
            window.addEventListener('beforeunload', function () {
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                navigator.sendBeacon('/log-activity', JSON.stringify({
                    username: username,
                    page: page,
                    event: 'page_leave',
                    duration: duration
                }));
            });
        });
    </script>



    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Marker Cluster for handling 10,000+ markers -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- Leaflet Draw for rectangle selection -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <style>
        :root {
            --primary-color: #00FFD1;
            /* Cyber Cyan */
            --flight-comm: #00FFD1;
            --flight-mil: #FF4400;
            --flight-priv: #FF00FF;
            --flight-emer: #FFFFFF;
            --background-dark: #000000;
            /* Deep Void */
            --card-background: rgba(5, 20, 20, 0.85);
            --accent-glow: rgba(0, 255, 209, 0.3);
            --cyberpunk-cyan: #00FFD1;
            --cyberpunk-blue: #00A3FF;
            --cyberpunk-magenta: #FF00FF;
            --glassmorphic-bg: rgba(0, 255, 209, 0.05);
            --glassmorphic-border: rgba(0, 255, 209, 0.2);
            --neon-pink: #FF0055;
            --neon-purple: #BC13FE;
            --neon-cyan: #00FFD1;
            --neon-white: #ffffff;
            --text-main: #00FFD1;
            --text-dim: rgba(0, 255, 209, 0.6);
            --border-color: rgba(0, 255, 209, 0.3);
            --cyan-glow: rgba(0, 255, 209, 0.6);
            --blue-glow: rgba(0, 163, 255, 0.6);
        }

        body.sat-mode {
            --primary-color: #FF00FF;
            --accent-glow: rgba(255, 0, 255, 0.3);
            --text-main: #FFB3FF;
            --text-dim: rgba(255, 179, 255, 0.6);
            --border-color: rgba(255, 0, 255, 0.3);
            --glassmorphic-bg: rgba(255, 0, 255, 0.05);
            --glassmorphic-border: rgba(255, 0, 255, 0.2);
        }

        .segment-label {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #FFFF00;
            color: #FFFF00;
            font-family: 'Courier New', Courier, monospace;
            font-size: 8px;
            font-weight: bold;
            padding: 1px 4px;
            pointer-events: none;
            text-transform: uppercase;
            white-space: nowrap;
            box-shadow: 0 0 5px rgba(255, 255, 0, 0.5);
            border-radius: 2px;
        }

        .segment-bbox {
            pointer-events: none;
            stroke-dasharray: 4, 4;
            animation: scan-line 2s linear infinite;
        }

        @keyframes scan-line {
            0% {
                stroke-opacity: 0.5;
            }

            50% {
                stroke-opacity: 1;
            }

            100% {
                stroke-opacity: 0.5;
            }
        }

        /* ---------- Base / Theme ---------- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family: 'Share Tech Mono', 'Courier New', monospace;
            background: var(--background-dark);
            color: var(--primary-color);
            overflow: hidden;
            letter-spacing: 0.5px;
        }

        /* Animated Grid Background */
        .bg-grid {
            position: fixed;
            inset: 0;
            z-index: 0;
            background-image:
                linear-gradient(rgba(0, 255, 209, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 209, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: center;
            opacity: 0.15;
            mask-image: radial-gradient(circle at center, black 40%, transparent 90%);
        }

        /* ---------- Top Navigation ---------- */
        .topnav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(2, 4, 5, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1100;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        .topnav::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 30%;
            height: 1px;
            background: linear-gradient(90deg, var(--primary-color), transparent);
            box-shadow: 0 0 10px var(--primary-color);
        }

        .left-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hamburger {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 2px;
            background: rgba(0, 255, 209, 0.1);
            border: 1px solid var(--border-color);
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .hamburger span {
            display: block;
            width: 20px;
            height: 2px;
            background: var(--primary-color);
            position: relative;
            transition: background 0.2s ease;
        }

        .hamburger span::before,
        .hamburger span::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 2px;
            background: var(--primary-color);
            left: 0;
            transition: transform 0.2s ease;
        }

        .hamburger span::before {
            top: -6px;
        }

        .hamburger span::after {
            top: 6px;
        }

        .hamburger[aria-expanded="true"] span {
            background: transparent;
        }

        .hamburger[aria-expanded="true"] span::before {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger[aria-expanded="true"] span::after {
            transform: rotate(-45deg) translate(5px, -5px);
        }

        .logo-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .logo-text h2 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 5px rgba(0, 255, 209, 0.5);
            font-family: 'Share Tech Mono', sans-serif;
        }

        .logo-text p {
            font-size: 9px;

            color: var(--text-dim);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Cyberpunk — Industrial Gold & Black Popup */
        .large-popup {
            --popup-accent: #FFCC00;
            width: 320px;
            padding: 16px;
            font-size: 11px;
            color: #EEE;
            background: #050505;
            border: 1px solid var(--popup-accent);
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.15), inset 0 0 10px rgba(255, 204, 0, 0.05);
            /* Sentry-style single bevels */
            clip-path: polygon(20px 0, 100% 0,
                    100% calc(100% - 20px), calc(100% - 20px) 100%,
                    0 100%, 0 20px);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
            display: none;
            backdrop-filter: blur(20px);
            font-family: 'Share Tech Mono', monospace;
            text-transform: uppercase;
            overflow: hidden;
            transition: border-color 0.3s ease;
        }

        /* Side Shapes / Decorative Elements */
        .large-popup::before {
            content: 'SECURED_LINK';
            position: absolute;
            top: 4px;
            left: 25px;
            font-size: 8px;
            color: var(--popup-accent);
            opacity: 0.5;
        }

        .large-popup::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, transparent 50%, rgba(255, 204, 0, 0.1) 50%);
            pointer-events: none;
        }

        /* Close button — Industrial Gold */
        .large-popup-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            font-size: 12px;
            border: 1px solid var(--popup-accent);
            background: transparent;
            color: var(--popup-accent);
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        .large-popup-close:hover {
            background: var(--popup-accent);
            color: #000;
            box-shadow: 0 0 15px var(--popup-accent);
        }

        /* Heading — Industrial Cyber */
        .large-popup h3 {
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--popup-accent);
            font-size: 14px;
            letter-spacing: 1px;
            color: var(--popup-accent);
            display: flex;
            justify-content: space-between;
        }

        /* Version Tag */
        .large-popup h3 span:last-child {
            font-size: 9px !important;
            color: #FF2E82 !important;
            /* Neon Pink contrast */
            padding: 2px 4px;
            background: rgba(255, 46, 130, 0.1);
        }

        .large-popup .popup-title {
            font-size: 12px !important;
            margin-bottom: 12px !important;
            color: #FFF;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            padding-bottom: 8px !important;
            max-height: 40px;
            overflow: hidden;
        }

        .large-popup .popup-data {
            gap: 8px;
            font-size: 10px;
            display: grid;
            grid-template-columns: 85px 1fr;
        }

        .large-popup .popup-data .data-label {
            color: var(--popup-accent);
            opacity: 0.6;
            font-size: 9px;
            text-align: left;
        }

        .large-popup .popup-data .data-value {
            color: var(--popup-accent);
            font-size: 10px;
            text-align: right;
        }

        .large-popup .popup-data .data-value.active {
            color: #00FF88;
            text-shadow: 0 0 8px #00FF88;
        }

        .large-popup .popup-data .data-value.alert {
            color: #FF2E82;
            text-shadow: 0 0 8px #FF2E82;
        }

        .large-popup .popup-footer {
            margin-top: 15px;
            font-size: 8px;
            color: var(--popup-accent);
            opacity: 0.4;
            text-align: center;
            border-top: 1px solid rgba(255, 204, 0, 0.1);
            padding-top: 8px;
        }

        /* Flow Bar for Traffic */
        .flow-container {
            grid-column: span 2;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            margin: 4px 0;
            position: relative;
            overflow: hidden;
        }

        .flow-bar {
            height: 100%;
            background: var(--popup-accent);
            transition: width 0.5s ease;
        }

        /* Spotify Integration Styles */
        .spotify-mini-player {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 255, 209, 0.05);
            border: 1px solid var(--border-color);
            padding: 5px 15px;
            border-radius: 2px;
            flex: 1;
            margin: 0 20px;
            max-width: 600px;
        }

        .album-art {
            width: 35px;
            height: 35px;
            border: 1px solid var(--primary-color);
            object-fit: cover;
        }

        .track-display {
            flex: 1;
            overflow: hidden;
            font-size: 11px;
            white-space: nowrap;
        }

        .track-display h4 {
            color: var(--neon-pink);
            margin: 0;
            font-size: 12px;
            text-transform: uppercase;
        }

        .track-display p {
            color: var(--text-dim);
            margin: 0;
        }

        .controlz {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .control-btn:hover {
            color: var(--neon-yellow);
            text-shadow: 0 0 10px var(--neon-yellow);
        }

        .nav-stats {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .stat-item {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 4px 12px;
            background: rgba(0, 255, 209, 0.05);
            border: 1px solid var(--border-color);
            font-size: 10px;
            color: var(--text-main);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #00FFD1;
            box-shadow: 0 0 8px #00FFD1;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        /* ---------- Sidebar ---------- */
        .sidebar {
            position: fixed;
            top: 60px;
            left: 0;
            width: 50px;
            height: calc(100vh - 60px);
            background: rgba(0, 0, 0, 0.98);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
            overflow: visible;
            z-index: 1000;
        }

        .menu-title {
            display: none;
        }

        .menu-title::after {
            content: '[_]';
        }

        .menu-item {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 0;
            color: var(--text-dim);
            cursor: pointer;
            border-left: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .menu-item span {
            display: none;
        }

        /* Tooltip on hover */
        .menu-item::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 55px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: var(--primary-color);
            padding: 8px 12px;
            border: 1px solid var(--primary-color);
            font-size: 11px;
            text-transform: uppercase;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1001;
            pointer-events: none;
        }

        .menu-item:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .menu-icon {
            min-width: 20px;
            width: 20px;
            height: 20px;
        }

        .menu-item:hover,
        .menu-item.active {
            background: linear-gradient(90deg, rgba(0, 255, 209, 0.1), transparent);
            border-left-color: var(--primary-color);
            color: var(--primary-color);
        }

        .menu-item.dropdown {
            flex-direction: column;
            align-items: stretch;
            padding: 0;
        }

        .dropdown-toggle {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 20px;
            cursor: pointer;
        }

        .dropdown-menu {
            display: none;
            flex-direction: column;
            margin-left: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-left: 1px solid var(--border-color);
        }

        .menu-item.dropdown:hover .dropdown-menu {
            display: flex;
        }

        .dropdown-menu a {
            padding: 8px 14px;
            font-size: 11px;
            color: var(--text-dim);
            text-decoration: none;
            transition: 0.2s;
        }

        .dropdown-menu a:hover {
            color: var(--neon-yellow);
            background: rgba(0, 255, 209, 0.05);
        }

        .dropdown-arrow {
            margin-left: auto;
            font-size: 10px;
            transition: transform 0.3s;
        }

        .menu-item.dropdown:hover .dropdown-arrow {
            transform: rotate(90deg);
        }

        /* ---------- Main Content ---------- */
        .container {
            margin-top: 60px;
            margin-left: 50px;
            height: calc(100vh - 60px);
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
        }

        .main-content {
            width: 95%;
            height: 90%;
            max-width: 1600px;
            padding: 0;
            position: relative;
            background: rgba(10, 31, 31, 0.4);
            border: 1px solid rgba(0, 255, 209, 0.1);
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .geo-tracker {
            display: flex;
            height: 100%;
            gap: 0;
            /* Seamless transition */
        }

        .map-container {
            flex: 2.5;
            position: relative;
            border-right: 1px solid var(--border-color);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .map-control-btn {
            background: rgba(2, 4, 5, 0.85);
            border: 1px solid var(--primary-color);
            padding: 10px 15px;
            color: var(--primary-color);
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            text-transform: uppercase;
            font-size: 11px;
            transition: 0.3s;
            outline: none;
        }

        .map-control-btn:hover {
            background: var(--primary-color);
            color: #000;
            box-shadow: 0 0 15px var(--primary-color);
        }

        .bots-container {
            flex: 1;
            background: rgba(2, 4, 5, 0.6);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            padding: 15px;
            height: 400px;
            /* Increased height */
            overflow-y: auto;
            /* Scrollable */
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) transparent;
        }

        .bots-container::-webkit-scrollbar {
            width: 4px;
        }

        .bots-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
        }

        .geojson-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid rgba(0, 255, 209, 0.1);
            color: var(--primary-color);
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
            transition: 0.3s;
        }

        .geojson-item:hover {
            background: rgba(0, 255, 209, 0.05);
        }

        .geojson-item.special {
            background: rgba(255, 0, 85, 0.05);
            border-left: 2px solid var(--neon-pink);
            margin-bottom: 5px;
        }

        .geojson-item.special label {
            color: var(--neon-pink);
            font-weight: bold;
        }

        .geojson-item input[type="checkbox"] {
            accent-color: var(--primary-color);
            cursor: pointer;
        }



        .bot-card {
            background: rgba(0, 255, 209, 0.03);
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            backdrop-filter: blur(5px);
            border-radius: 4px;
        }

        .bot-card:hover {
            background: rgba(0, 255, 209, 0.1);
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 209, 0.1);
        }

        .bot-card h4 {
            color: var(--primary-color);
            margin-bottom: 12px;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(0, 255, 209, 0.2);
            padding-bottom: 8px;
        }

        .bot-card p {
            font-size: 11px;
            line-height: 1.5;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .bot-card p strong {
            color: var(--primary-color);
            font-weight: 700;
        }

        .bot-card button {
            margin-top: 12px;
            width: 100%;
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            text-transform: uppercase;
            transition: 0.3s;
            font-size: 11px;
        }

        .bot-card button:hover {
            background: var(--primary-color);
            color: #000;
            box-shadow: 0 0 15px var(--primary-color);
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            stroke: currentColor;
        }





        .large-popup h3 {
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
        }


        /* Custom Cyber Marker Styles */
        .custom-cyber-marker {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .marker-core {
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--primary-color);
            z-index: 2;
        }

        .marker-pulse {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: markerPulse 2s infinite;
            opacity: 0;
            z-index: 1;
        }

        @keyframes markerPulse {
            0% {
                transform: scale(0.5);
                opacity: 0.8;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        /* Flight Tracker Styles */
        .flight-icon-container {
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease;
        }

        .flight-path {
            stroke-dasharray: 4;
            animation: dash 20s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -100;
            }
        }

        /* Legend Style */
        .map-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(2, 4, 5, 0.85);
            border: 1px solid var(--border-color);
            padding: 10px;
            font-size: 10px;
            backdrop-filter: blur(5px);
            display: none;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .legend-close {
            position: absolute;
            top: 2px;
            right: 5px;
            cursor: pointer;
            color: var(--text-dim);
        }

        /* Search Dropdown Style */
        .search-container {
            display: flex;
            background: rgba(2, 4, 5, 0.85);
            border: 1px solid var(--primary-color);
            border-radius: 2px;
            overflow: hidden;
        }

        #search-type {
            background: transparent;
            color: var(--primary-color);
            border: none;
            border-right: 1px solid var(--border-color);
            font-size: 10px;
            padding: 0 5px;
            outline: none;
            cursor: pointer;
        }

        #search-type option {
            background: var(--background-dark);
        }

        #advanced-search {
            background: transparent;
            color: var(--primary-color);
            border: none;
            padding: 4px 6px;
            font-size: 10px;
            width: 140px;
            /* Reduced width */
            outline: none;
        }

        .map-control-btn {
            background: rgba(2, 4, 5, 0.85);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 4px 8px;
            /* Reduced padding */
            font-size: 10px;
            /* Smaller font */
            border-radius: 2px;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            outline: none;
        }

        .flight-filter-container {
            display: flex;
            gap: 2px;
            margin-left: 5px;
        }

        .flight-filter-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--primary-color);
            color: var(--text-dim);
            padding: 2px 5px;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .flight-filter-btn.active {
            background: var(--primary-color);
            color: #000;
            font-weight: bold;
        }

        .flight-filter-btn.mil {
            border-color: #FF4400;
            color: #FF4400;
        }

        .flight-filter-btn.mil.active {
            background: #FF4400;
            color: #fff;
        }

        .flight-filter-btn.priv {
            border-color: #FF00FF;
            color: #FF00FF;
        }

        .flight-filter-btn.priv.active {
            background: #FF00FF;
            color: #fff;
        }

        .flight-filter-btn.emerg {
            border-color: #fff;
            color: #fff;
        }

        .flight-filter-btn.emerg.active {
            background: #fff;
            color: #000;
        }

        .external-link {
            color: var(--cyberpunk-blue);
            text-decoration: underline;
            margin-right: 10px;
            font-size: 10px;
        }

        /* Leaflet Popup Cyber Theme */
        .leaflet-popup-content-wrapper {
            background: rgba(2, 4, 5, 0.9) !important;
            color: var(--primary-color) !important;
            border: 1px solid var(--primary-color) !important;
            border-radius: 4px !important;
            font-family: 'Share Tech Mono', monospace !important;
            backdrop-filter: blur(10px);
        }

        .leaflet-popup-tip {
            background: var(--primary-color) !important;
        }

        .popup-detail-item {
            font-size: 11px;
            margin-bottom: 4px;
            border-bottom: 1px solid rgba(0, 255, 209, 0.2);
            padding-bottom: 2px;
        }

        .popup-detail-item strong {
            color: var(--text-dim);
            margin-right: 5px;
        }

        .popup-header {
            font-size: 8px;
            color: var(--neon-pink);
            letter-spacing: 2px;
            margin-bottom: 6px;
            border-bottom: 1px solid rgba(255, 0, 85, 0.2);
            padding-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .popup-title {
            font-size: 10px;
            /* Smaller font for long address */
            color: var(--neon-yellow);
            margin-bottom: 10px;
            line-height: 1.4;
            max-height: 60px;
            overflow-y: auto;
        }

        .popup-data {
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 5px;
            font-size: 10px;
        }

        .data-label {
            color: var(--text-dim);
        }

        .data-value {
            color: var(--primary-color);
            text-align: right;
        }

        .data-value.active {
            color: #00FF00;
            text-shadow: 0 0 5px #00FF00;
        }

        .data-value.alert {
            color: var(--neon-pink);
            text-shadow: 0 0 5px var(--neon-pink);
        }

        @media (max-width: 968px) {
            .hamburger {
                display: flex;
            }

            .container {
                margin-left: 0;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .geo-tracker {
                flex-direction: column;
            }

            .spotify-mini-player {
                display: none;
            }
        }



        .cyber-mode .leaflet-tile-pane {
            /* Since OSM is light, we invert it to get a dark theme, then apply neon shifts */
            filter: invert(100%) hue-rotate(180deg) brightness(0.8) contrast(1.2) saturate(2);
            background: #000 !important;
        }

        .cyber-mode .leaflet-container {
            background: #000 !important;
        }

        /* Player Styles */
        .controlz {
            display: flex;
            gap: 8px;
            margin: 0 15px;
        }

        .controlz button {
            background: rgba(0, 255, 209, 0.05);
            border: 1px solid rgba(0, 255, 209, 0.3);
            color: var(--primary-color);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.3s;
            font-size: 12px;
        }

        .controlz button:hover {
            background: var(--primary-color);
            color: #000;
            box-shadow: 0 0 10px var(--primary-color);
        }

        .stat-item marquee {
            width: 120px;
            font-family: 'Share Tech Mono', monospace;
            color: var(--primary-color);
        }

        .stat-item h4 {
            margin: 0;
            font-size: 11px;
            white-space: nowrap;
        }

        /* Network Dropdown in Topnav */
        .nav-stats .dropdown-menu {
            right: 0;
            left: auto;
        }

        .nav-stats .dropdown-toggle {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-color);
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
        }

        /* Coordinate Display Styles */
        #coord-display {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(5, 10, 10, 0.7);
            color: #00FF88;
            padding: 6px 15px;
            border-radius: 20px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.1);
            transition: all 0.3s ease;
        }

        #coord-display:hover {
            background: rgba(5, 20, 20, 0.9);
            border-color: rgba(0, 255, 136, 0.6);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .coord-btn {
            background: none;
            border: none;
            color: rgba(0, 255, 136, 0.7);
            cursor: pointer;
            font-size: 12px;
            padding: 2px 5px;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .coord-btn:hover {
            color: #fff;
            background: rgba(0, 255, 136, 0.2);
        }

        #map-links-menu {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(5, 15, 15, 0.95);
            border: 1px solid #00FF88;
            border-radius: 4px;
            padding: 5px;
            display: none;
            flex-direction: column;
            gap: 2px;
            min-width: 140px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
            z-index: 1001;
        }

        #map-links-menu::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #00FF88;
        }

        #map-links-menu a {
            color: #00FF88;
            text-decoration: none;
            font-size: 10px;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 2px;
            transition: background 0.2s;
        }

        #map-links-menu a:hover {
            background: rgba(0, 255, 136, 0.15);
            color: #fff;
        }

        /* --- GeoSential AI Custom Styles --- */
        .ai-msg {
            background: rgba(0, 255, 209, 0.1);
            border-left: 2px solid #00FFD1;
            padding: 10px 12px;
            border-radius: 4px;
            font-size: 11px;
            color: #00FFD1 !important;
            line-height: 1.5;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            word-wrap: break-word;
            max-width: 100%;
        }

        .user-msg {
            background: rgba(0, 153, 255, 0.15);
            border-right: 2px solid #0099FF;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            color: #0099FF !important;
            align-self: flex-end;
            text-align: right;
            max-width: 85%;
            word-wrap: break-word;
        }

        .system-msg {
            color: #FF6B00 !important;
            font-size: 9px;
            text-align: center;
            font-weight: bold;
            padding: 4px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        /* Markdown in AI Responses */
        .ai-msg blockquote {
            border-left: 3px solid rgba(0, 255, 209, 0.3);
            margin: 8px 0;
            padding: 5px 10px;
            background: rgba(0, 255, 209, 0.05);
            color: rgba(0, 255, 209, 0.82) !important;
            font-style: italic;
        }

        .ai-msg a {
            color: #00A3FF !important;
            text-decoration: underline;
            font-weight: bold;
        }

        .ai-msg a:hover {
            color: #00FFD1 !important;
            text-shadow: 0 0 5px #00FFD1;
        }

        .ai-msg code {
            background: rgba(0, 0, 0, 0.5);
            color: #FFCC00 !important;
            padding: 1px 4px;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
        }

        .ai-msg p {
            margin-bottom: 8px;
        }

        .ai-msg ul,
        .ai-msg ol {
            padding-left: 15px;
            margin-bottom: 8px;
        }

        .ai-msg strong {
            color: #FFF !important;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
        }

        @keyframes msg-slide-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-msg,
        .user-msg {
            animation: msg-slide-in 0.3s ease-out;
        }

        /* Scan Pulse Animation */
        @keyframes scan-pulse {
            0% {
                transform: scale(0.1);
                opacity: 0.8;
                border-width: 4px;
            }

            100% {
                transform: scale(2);
                opacity: 0;
                border-width: 1px;
            }
        }

        .scan-pulse-div {
            border: 2px solid #00FFD1;
            border-radius: 50%;
            pointer-events: none;
            position: absolute;
            width: 200px;
            height: 200px;
            margin-left: -100px;
            margin-top: -100px;
            animation: scan-pulse 2.5s cubic-bezier(0.1, 0, 0.3, 1) forwards;
            background: radial-gradient(circle, rgba(0, 255, 209, 0.2) 0%, transparent 70%);
        }
    </style>
</head>

<body>
    <div class="bg-grid"></div>

    <!-- Top Navigation -->
    <nav class="topnav">
        <div class="left-group">
            <button class="hamburger" id="hamburger" aria-label="Open menu">
                <span></span>
            </button>
            <div class="logo-section" onclick="window.location.href='/'" style="cursor: pointer;">
                <div class="logo-icon" aria-hidden="true">
                    <svg width="40" height="40" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
                        <g transform="translate(10, 15)">
                            <path
                                d="M30 30 C25 15, 35 10, 40 15 C45 10, 55 15, 50 30 C55 45, 45 50, 40 45 C35 50, 25 45, 30 30"
                                fill="none" stroke="#00FF88" stroke-width="4" />
                            <path d="M30 30 C25 20, 20 15, 15 10" stroke="#00FF88" stroke-width="3" fill="none" />
                            <path d="M50 30 C55 20, 60 15, 65 10" stroke="#00FF88" stroke-width="3" fill="none" />
                            <path d="M30 30 C25 40, 20 45, 15 50" stroke="#00FF88" stroke-width="3" fill="none" />
                            <path d="M50 30 C55 40, 60 45, 65 50" stroke="#00FF88" stroke-width="3" fill="none" />
                            <circle cx="30" cy="30" r="5" fill="none" stroke="#00FF88" stroke-width="2" opacity="0.0" />
                            <circle cx="50" cy="30" r="5" fill="none" stroke="#00FF88" stroke-width="2" opacity="0.0" />
                            <circle cx="15" cy="10" r="3" fill="none" stroke="#00FF88" stroke-width="1.5"
                                opacity="0.0" />
                            <circle cx="65" cy="10" r="3" fill="none" stroke="#00FF88" stroke-width="1.5"
                                opacity="0.0" />
                            <circle cx="15" cy="50" r="3" fill="none" stroke="#00FF88" stroke-width="1.5"
                                opacity="0.0" />
                            <circle cx="65" cy="50" r="3" fill="none" stroke="#00FF88" stroke-width="1.5"
                                opacity="0.0" />
                        </g>
                    </svg>
                </div>
                <div class="logo-text">
                    <h2>HayOS H9 EYE</h2>
                    <p id="user-info">Created by Hayden |</p>
                    <script>
                        (async function () {
                            try {
                                const res = await fetch('/api/username', { cache: 'no-store' });
                                const data = await res.json();

                                const userInfo = document.getElementById('user-info');
                                const deviceCount = document.getElementById('device-counts');
                                const statItemNav = document.querySelector('.stat-item');

                                if (data && data.username) {
                                    userInfo.innerHTML = `Created by Hayden | ${data.username}`;
                                    deviceCount.textContent = 'Online';
                                    const logoutBtn = document.createElement('a');
                                    logoutBtn.href = '/logout';
                                    logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i>';
                                    logoutBtn.title = 'Logout';
                                    logoutBtn.style.marginLeft = '10px';
                                    logoutBtn.style.color = '#00FFFF';
                                    logoutBtn.style.cursor = 'pointer';
                                    logoutBtn.style.textDecoration = 'none';
                                    logoutBtn.style.fontSize = '16px';
                                    logoutBtn.addEventListener('mouseenter', () => logoutBtn.style.color = '#FF4444');
                                    logoutBtn.addEventListener('mouseleave', () => logoutBtn.style.color = '#00FFFF');
                                    if (statItemNav) statItemNav.appendChild(logoutBtn);
                                } else {
                                    userInfo.innerHTML = 'Created by Hayden | Guest';
                                    deviceCount.textContent = 'Offline';
                                }
                            } catch (err) {
                                console.warn('Failed to fetch username:', err);
                                const userInfo = document.getElementById('user-info');
                                if (userInfo) userInfo.innerHTML = 'Created by Hayden | Guest';
                            }
                        })();
                    </script>
                </div>
            </div>
        </div>
        <div class="stat-item">

            <div class="status-dot active" aria-hidden="true"
                style="background: #00FFD1; width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 10px #00FFD1;">
            </div>
            <span id="device-counts"
                style="font-family: 'Share Tech Mono', monospace; font-size: 12px; color: var(--primary-color);">Loading...</span>
        </div>


        <div class="nav-stats" style="margin-left: 15px;">
            <div class="menu-item dropdown">
                <div class="dropdown-toggle">
                    <i class="fas fa-network-wired"></i>
                    Network
                    <span class="dropdown-arrow">▶</span>
                </div>
                <div class="dropdown-menu">
                    <a href="#">WiFi Scan</a>
                    <a href="#">Bluetooth</a>
                    <a href="#">Devices</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Vertical Sidebar -->
        <aside class="sidebar" id="sidebar" aria-label="Primary navigation">
            <div class="menu-group">
                <div class="menu-title">Main</div>
                <div class="menu-item active" data-href="/crmx" data-tooltip="Dashboard"><svg class="menu-icon"
                        fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    </svg><span>Dashboard</span></div>
                <div class="menu-item" data-href="/surveillance" data-tooltip="Surveillance"><svg class="menu-icon"
                        fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg><span>Surveillance</span></div>
                <div class="menu-item" id="tor-chat" data-href="/tor-chat" data-tooltip="Admin Panel">
                    <svg class="menu-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>
                    <span>Admin Panel</span>
                </div>
                <div class="menu-item" data-href="/profiles" data-tooltip="Profiles"><svg class="menu-icon" fill="none"
                        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                    </svg><span>Profiles</span></div>
                <div class="menu-item" data-href="/tor-chat" data-tooltip="Local Tor Chat"><svg class="menu-icon"
                        fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                    </svg><span>Local Tor Chat</span></div>
                <div class="menu-item" data-href="/earth" data-tooltip="Geo Tracking"><svg class="menu-icon" fill="none"
                        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                        <circle cx="12" cy="10" r="3" />
                    </svg><span>Geo Tracking</span></div>
                <div class="menu-item" data-href="/neural" data-tooltip="Neural Core"><i
                        class="fas fa-brain menu-icon"></i><span>Neural
                        Core</span></div>
            </div>

            <div class="menu-group">
                <div class="menu-title">Data Sources</div>
                <div class="menu-item" data-href="/cctv" data-tooltip="CCTV Feeds"><svg class="menu-icon" fill="none"
                        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" />
                        <circle cx="12" cy="13" r="3" />
                    </svg><span>CCTV Feeds</span></div>
                <div class="menu-item" data-href="/mobile" data-tooltip="Mobile Tracking"><svg class="menu-icon"
                        fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                    </svg><span>Mobile Tracking</span></div>
                <div class="menu-item" data-href="/social" data-tooltip="Social Media"><svg class="menu-icon"
                        fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                    </svg><span>Social Media</span></div>
            </div>

            <div class="menu-group">
                <div class="menu-title">System</div>
                <div class="menu-item" data-href="/alerts" data-tooltip="Alerts"><svg class="menu-icon" fill="none"
                        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
                    </svg><span>Alerts</span></div>
                <div class="menu-item" data-href="/fit" data-tooltip="Fitness"><svg class="menu-icon" fill="none"
                        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" />
                        <path d="M8 12 L10 14 L16 8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                            stroke-linejoin="round" fill="none" />
                    </svg><span>Fit</span></div>
                <div class="menu-item" data-href="/settings"><svg class="menu-icon" fill="none" stroke="currentColor"
                        stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="3" />
                        <path d="M12 1v6m0 6v6m-9-9h6m6 0h6" />
                    </svg><span>Settings</span></div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="geo-tracker">
                <div class="map-container">
                    <div id="map"></div>

                    <!-- Omni-Search Toggle Button (Top-Right of Map) -->
                    <button id="omni-search-toggle-btn" title="Open Omni-Search"
                        style="position: absolute; top: 15px; right: 15px; z-index: 4000; background: rgba(0, 15, 30, 0.8); border: 1px solid #00FFD1; color: #00FFD1; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px rgba(0, 255, 209, 0.3); transition: all 0.3s;">
                        <i class="fas fa-search" style="font-size: 16px;"></i>
                    </button>

                    <!-- Advanced Web Scraper Control (Hidden by default) -->
                    <div id="web-scraper-control"
                        style="position: absolute; top: 15%; left: 50%; transform: translateX(-50%); z-index: 5000; display: none; flex-direction: column; gap: 8px; background: rgba(5, 10, 15, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(0, 255, 209, 0.6); padding: 15px; border-radius: 8px; box-shadow: 0 0 40px rgba(0, 255, 209, 0.2); width: 600px; max-width: 90%;">

                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div
                                style="display: flex; align-items: center; gap: 10px; font-size: 12px; color: #00FFD1;">
                                <span
                                    style="letter-spacing: 2px; font-weight: bold; font-family: 'Orbitron', sans-serif;">OMNI-SEARCH
                                    ARRAY</span>
                                <span style="opacity: 0.5;">|</span>
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"
                                    title="Fetch full page content (Slower)">
                                    <input type="checkbox" id="scrape-aggressive">
                                    <span style="font-size: 10px;">AGGRESSIVE_MODE</span>
                                </label>
                            </div>
                            <div id="omni-close-bar"
                                style="cursor: pointer; color: #00FFD1; font-size: 18px; opacity: 0.8;">&times;</div>
                        </div>

                        <div style="display: flex; gap: 8px;">
                            <select id="scrape-type"
                                style="background: rgba(0, 20, 40, 0.8); color: #00FFD1; border: 1px solid rgba(0, 255, 209, 0.3); font-size: 11px; padding: 6px; border-radius: 4px; outline: none; flex: 1;">
                                <option value="all">ALL TYPES</option>
                                <option value="news">NEWS</option>
                                <option value="images">IMAGES</option>
                                <option value="videos">VIDEOS_</option>
                            </select>
                            <div
                                style="display: flex; flex-direction: column; gap: 5px; background: rgba(0, 20, 40, 0.5); padding: 8px; border: 1px solid rgba(0, 255, 209, 0.2);">
                                <div style="font-size: 9px; color: #00FFD1; margin-bottom: 2px;">TARGET_SOURCES
                                    [AGGRESSIVE_MODE]</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                                    <label
                                        style="display: flex; align-items: center; gap: 4px; font-size: 9px; color: #00FFD1; cursor: pointer;"><input
                                            type="checkbox" class="scrape-source-cb" value="web" checked>
                                        WEB_GENERAL</label>
                                    <label
                                        style="display: flex; align-items: center; gap: 4px; font-size: 9px; color: #00FFD1; cursor: pointer;"><input
                                            type="checkbox" class="scrape-source-cb" value="twitter"> TWITTER_X</label>
                                    <label
                                        style="display: flex; align-items: center; gap: 4px; font-size: 9px; color: #00FFD1; cursor: pointer;"><input
                                            type="checkbox" class="scrape-source-cb" value="reddit">
                                        REDDIT_THREADS</label>
                                    <label
                                        style="display: flex; align-items: center; gap: 4px; font-size: 9px; color: #00FFD1; cursor: pointer;"><input
                                            type="checkbox" class="scrape-source-cb" value="darkweb">
                                        DARK_NET_RELAY</label>
                                    <label
                                        style="display: flex; align-items: center; gap: 4px; font-size: 9px; color: #00FFD1; cursor: pointer;"><input
                                            type="checkbox" class="scrape-source-cb" value="instagram">
                                        INSTAGRAM_FEED</label>
                                    <label
                                        style="display: flex; align-items: center; gap: 4px; font-size: 9px; color: #00FFD1; cursor: pointer;"><input
                                            type="checkbox" class="scrape-source-cb" value="telegram">
                                        TELEGRAM_CHANA</label>
                                    <label
                                        style="display: flex; align-items: center; gap: 4px; font-size: 9px; color: #00FFD1; cursor: pointer;"><input
                                            type="checkbox" class="scrape-source-cb" value="discord">
                                        DISCORD_LEAKS</label>
                                    <label
                                        style="display: flex; align-items: center; gap: 4px; font-size: 9px; color: #00FFD1; cursor: pointer;"><input
                                            type="checkbox" class="scrape-source-cb" value="pastebin">
                                        PASTEBIN_DUMPS</label>
                                    <label
                                        style="display: flex; align-items: center; gap: 4px; font-size: 9px; color: #00FFD1; cursor: pointer;"><input
                                            type="checkbox" class="scrape-source-cb" value="github">
                                        GITHUB_REPOS</label>
                                    <label
                                        style="display: flex; align-items: center; gap: 4px; font-size: 9px; color: #00FFD1; cursor: pointer;"><input
                                            type="checkbox" class="scrape-source-cb" value="stackoverflow">
                                        STACK_OVERFLOW</label>
                                    <label
                                        style="display: flex; align-items: center; gap: 4px; font-size: 9px; color: #00FFD1; cursor: pointer;"><input
                                            type="checkbox" class="scrape-source-cb" value="leaks">
                                        DATA_BREACH_DB</label>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="scrape-query" placeholder="ENTER_VECTOR_QUERY..."
                                style="background: rgba(0, 255, 209, 0.05); border: 1px solid #00FFD1; color: #fff; padding: 8px 12px; font-size: 12px; outline: none; border-radius: 4px; flex: 1; font-family: 'Courier New'; letter-spacing: 0.5px;">
                            <button id="scrape-btn"
                                style="background: rgba(0, 255, 209, 0.15); border: 1px solid #00FFD1; color: #00FFD1; font-weight: bold; font-size: 12px; padding: 0 20px; cursor: pointer; border-radius: 4px; transition: 0.2s; letter-spacing: 1px;">SCAN</button>
                        </div>
                    </div>

                    <!-- Coordinate Display Control -->
                    <div id="coord-display">
                        <i class="fas fa-crosshairs" style="color:var(--neon-pink); font-size:10px;"></i>
                        <span id="coord-text">LAT: 0.0000 LON: 0.0000</span>
                        <div style="height:12px; width:1px; background:rgba(0,255,136,0.3); margin:0 5px;"></div>
                        <button class="coord-btn" id="copy-coords" title="Copy Coordinates"><i
                                class="fas fa-copy"></i></button>
                        <button class="coord-btn" id="open-maps" title="Open in External Map"><i
                                class="fas fa-globe"></i></button>

                        <div id="map-links-menu">
                            <a href="#" id="link-google-maps" target="_blank"><i class="fab fa-google"></i> Google
                                Maps</a>
                            <a href="#" id="link-google-earth" target="_blank"><i class="fas fa-globe-americas"></i>
                                Google Earth</a>
                            <a href="#" id="link-osm" target="_blank"><i class="fas fa-map-marked-alt"></i>
                                OpenStreetMap</a>
                        </div>
                    </div>
                    <div class="map-controls">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <div style="display: flex; gap: 5px;">
                                <input type="text" id="coord-search" class="map-control-btn" placeholder="LAT, LONG">
                                <input type="text" id="place-search" class="map-control-btn"
                                    placeholder="SEARCH SECTOR">
                                <form id="user-uplink-form" action="/upload" method="post" enctype="multipart/form-data"
                                    style="display: flex; gap: 2px; align-items: center; background: rgba(0, 255, 209, 0.05); border: 1px solid #00FFD1; padding: 1px 5px; border-radius: 3px;">
                                    <label for="img" style="font-size: 8px; color: #00FFD1; white-space: nowrap;">Select
                                        image:</label>
                                    <input type="file" id="img" name="img" accept="image/*"
                                        style="font-size: 8px; color: #00FFD1; width: 80px;">
                                    <input type="submit" value="Upload Image"
                                        style="background: #00FFD1; color: #000; border: none; font-size: 8px; padding: 1px 4px; cursor: pointer; font-weight: bold; text-transform: uppercase;">
                                </form>
                            </div>
                            <div class="search-container">
                                <select id="search-type" style="padding: 0 5px; height: 100%;">
                                    <option value="hex">HEX</option>
                                    <option value="reg">REG</option>
                                    <option value="call">CALL</option>
                                    <option value="type">TYPE</option>
                                </select>
                                <input type="text" id="advanced-search" placeholder="FLIGHT SEARCH...">

                                <div class="flight-filter-container">
                                    <button class="flight-filter-btn active" data-filter="all">ALL</button>
                                    <button class="flight-filter-btn mil" data-filter="military">MIL</button>
                                    <button class="flight-filter-btn priv" data-filter="private">PRI</button>
                                    <button class="flight-filter-btn emerg" data-filter="emergency">EM</button>
                                </div>
                            </div>
                            <!-- Ship Search Container -->
                            <div class="search-container" style="margin-top: 5px;">
                                <select id="ship-search-type"
                                    style="padding: 0 5px; height: 100%; background:rgba(2, 4, 5, 0.9); border:1px solid #00FF88; color:#00FF88; font-family: 'Share Tech Mono', monospace; font-size:10px; outline:none; text-transform:uppercase;">
                                    <option value="name">NAME</option>
                                    <option value="mmsi">MMSI</option>
                                </select>
                                <input type="text" id="ship-search-input" placeholder="VESSEL..."
                                    style="flex:1; background:rgba(2, 4, 5, 0.9); border:1px solid #00FF88; border-left:none; color:#00FF88; font-family: 'Share Tech Mono', monospace; font-size:10px; padding:2px 5px; outline:none; height: 20px;">

                                <div class="vessel-filter-container" style="display:flex; gap:2px; margin-left:5px;">
                                    <button class="vessel-filter-btn active" data-filter="all"
                                        style="background:rgba(0, 255, 136, 0.2); border:1px solid #00FF88; color:#00FF88; font-size:9px; padding:2px 4px; cursor:pointer;">ALL</button>
                                    <button class="vessel-filter-btn" data-filter="cargo"
                                        style="background:rgba(0, 204, 255, 0.1); border:1px solid #00CCFF; color:#00CCFF; font-size:9px; padding:2px 4px; cursor:pointer;">CARGO</button>
                                    <button class="vessel-filter-btn" data-filter="tanker"
                                        style="background:rgba(255, 68, 68, 0.1); border:1px solid #FF4444; color:#FF4444; font-size:9px; padding:2px 4px; cursor:pointer;">TANK</button>
                                    <button class="vessel-filter-btn" data-filter="military"
                                        style="background:rgba(255, 68, 0, 0.1); border:1px solid #FF4400; color:#FF4400; font-size:9px; padding:2px 4px; cursor:pointer;">MIL</button>
                                    <button class="vessel-filter-btn" data-filter="fishing"
                                        style="background:rgba(255, 170, 0, 0.1); border:1px solid #FFAA00; color:#FFAA00; font-size:9px; padding:2px 4px; cursor:pointer;">FISH</button>
                                </div>
                            </div>
                        </div>
                        <button class="map-control-btn" id="layer-toggle">
                            <i class="fas fa-layer-group"></i> SWITCH_SENSOR
                        </button>
                    </div>
                    <div id="map-legend" class="map-legend">
                        <div class="legend-close" onclick="document.getElementById('map-legend').style.display='none'">×
                        </div>
                        <div
                            style="color:var(--primary-color); margin-bottom:5px; border-bottom:1px solid var(--border-color);">
                            UPLINK_LEGEND</div>
                        <div class="legend-item">
                            <div class="legend-color" style="background:var(--flight-mil)"></div> <i
                                class="fas fa-fighter-jet" style="color:var(--flight-mil)"></i> MILITARY
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background:var(--flight-comm)"></div> <i
                                class="fas fa-plane" style="color:var(--flight-comm)"></i> COMMERCIAL
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background:var(--flight-priv)"></div> <i
                                class="fas fa-plane-departure" style="color:var(--flight-priv)"></i> PRIVATE
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background:var(--flight-emer)"></div> <i
                                class="fas fa-plus-square" style="color:var(--flight-emer)"></i> EMERGENCY
                        </div>
                    </div>
                    <div id="large-popup" class="large-popup"></div>


                </div>
                <div class="bots-container" id="bots-list">
                    <div class="geojson-item special">
                        <input type="checkbox" id="grid-toggle" class="grid-checkbox">
                        <label for="grid-toggle">GLOBAL_SURVEILLANCE_GRID</label>
                    </div>

                    <div class="geojson-item special"
                        style="background: rgba(0, 163, 255, 0.05); border-left: 2px solid var(--cyberpunk-blue);">
                        <input type="checkbox" id="flight-toggle" class="flight-checkbox">
                        <label for="flight-toggle" style="color: var(--cyberpunk-blue);"><i class="fas fa-plane"></i>
                            SKY_SCAN_FLIGHT_TRACKER</label>
                    </div>
                    <div id="flights-active-list"
                        style="display: none; background: rgba(0, 163, 255, 0.02); border-left: 1px solid var(--cyberpunk-blue); margin-bottom: 10px;">
                        <div class="log-entry info" style="padding: 5px; font-size: 10px;">AWAITING_SKYSCAN_LINK...
                        </div>
                    </div>

                    <div class="geojson-item special"
                        style="background: rgba(0, 255, 136, 0.05); border-left: 2px solid #00FF88;">
                        <input type="checkbox" id="vessel-toggle" class="vessel-checkbox">
                        <label for="vessel-toggle" style="color: #00FF88;"><i class="fas fa-ship"></i>
                            VESSEL_HARBOR_UPLINK</label>
                    </div>
                    <div id="vessels-active-list"
                        style="display: none; background: rgba(0, 255, 136, 0.02); border-left: 1px solid #00FF88; margin-bottom: 10px;">
                        <div class="log-entry info" style="padding: 5px; font-size: 10px;">AWAITING_VESSEL_LINK...
                        </div>
                    </div>

                    <div class="geojson-item special"
                        style="background: rgba(255, 166, 0, 0.05); border-left: 2px solid #FFA600;">
                        <input type="checkbox" id="traffic-toggle" class="traffic-checkbox">
                        <label for="traffic-toggle" style="color: #FFA600;"><i class="fas fa-traffic-light"></i>
                            TOMTOM_TRAFFIC_UPLINK</label>
                    </div>
                    <div id="traffic-active-list"
                        style="display: none; background: rgba(255, 166, 0, 0.02); border-left: 1px solid #FFA600; margin-bottom: 10px; max-height: 300px; overflow-y: auto;">
                        <div class="log-entry info" style="padding: 5px; font-size: 10px;">AWAITING_TRAFFIC_LINK...
                        </div>
                    </div>

                    <div class="geojson-item special"
                        style="background: rgba(200, 200, 200, 0.05); border-left: 2px solid #ccc;">
                        <input type="checkbox" id="coord-toggle" class="coord-checkbox">
                        <label for="coord-toggle" style="color: #ccc;"><i class="fas fa-map-marker-alt"></i>
                            COORDINATE_UPLINK</label>
                    </div>
                    <div id="coord-active-list"
                        style="display: none; background: rgba(200, 200, 200, 0.02); border-left: 1px solid #ccc; margin-bottom: 10px;">
                        <div class="log-entry info" style="padding: 5px; font-size: 10px; color:#ccc;">
                            CLICK_MAP_FOR_COORDS...</div>
                    </div>

                    <div class="geojson-item special"
                        style="background: rgba(0, 255, 230, 0.05); border-left: 2px solid var(--neon-cyan);">
                        <input type="checkbox" id="sentiment-toggle" class="sentiment-checkbox">
                        <label for="sentiment-toggle" style="color: var(--neon-cyan);"><i
                                class="fas fa-globe-americas"></i>
                            GLOBAL_SENTIMENT_ANALYSIS</label>
                    </div>
                    <div id="sentiment-active-list"
                        style="display: none; background: rgba(0, 255, 230, 0.02); border-left: 1px solid var(--neon-cyan); margin-bottom: 10px;">
                        <div class="log-entry info" style="padding: 5px; font-size: 10px; color:var(--neon-cyan);">
                            CLICK_MAP_TO_SCAN_SECTOR...</div>
                    </div>


                    <div class="geojson-item special"
                        style="background: rgba(188, 19, 254, 0.05); border-left: 2px solid var(--neon-purple);">
                        <input type="checkbox" id="tower-toggle" class="tower-checkbox">
                        <label for="tower-toggle" style="color: var(--neon-purple);"><i
                                class="fas fa-broadcast-tower"></i>
                            CELL_TOWER_UPLINK</label>
                    </div>
                    <div id="towers-active-list"
                        style="display: none; background: rgba(188, 19, 254, 0.02); border-left: 1px solid var(--neon-purple); margin-bottom: 10px; max-height: 300px; overflow-y: auto;">
                        <div class="log-entry info" style="padding: 5px; font-size: 10px;">AWAITING_TOWER_LINK...
                        </div>
                    </div>

                    <div class="geojson-item special"
                        style="background: rgba(0, 255, 209, 0.05); border-left: 2px solid var(--primary-color);">
                        <input type="checkbox" id="earth-networks-toggle" class="earth-networks-checkbox">
                        <label for="earth-networks-toggle" style="color: var(--primary-color);"><i
                                class="fas fa-wifi"></i>
                            EARTH_NETWORKS_UPLINK</label>
                    </div>
                    <div id="earth-networks-active-list"
                        style="display: none; background: rgba(0, 255, 209, 0.02); border-left: 1px solid var(--primary-color); margin-bottom: 10px; max-height: 300px; overflow-y: auto;">
                        <div class="log-entry info" style="padding: 5px; font-size: 10px;">AWAITING_NETWORK_LINK...
                        </div>
                    </div>

                    <!-- Sidebar Uplink Moved to Map -->
                    <div id="segments-active-list"
                        style="display: none; background: rgba(255, 255, 0, 0.02); border-left: 1px solid #FFFF00; margin-bottom: 10px; max-height: 300px; overflow-y: auto;">
                        <div class="log-entry info" style="padding: 5px; font-size: 10px;">AWAITING_SAT_ANALYSIS...
                        </div>
                    </div>

                    {% if geojson_files %}
                    {% for file in geojson_files %}
                    <div class="geojson-item">
                        <input type="checkbox" class="geojson-checkbox" data-filename="{{ file }}"
                            id="chk-{{ loop.index }}">
                        <label for="chk-{{ loop.index }}">{{ file }}</label>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="geojson-item">NO GEOJSON FILES FOUND IN GEODATA/</div>
                    {% endif %}
                </div>

            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // Sidebar & Hamburger Logic
        const hamburger = document.getElementById('hamburger');
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');

        if (hamburger && sidebar) {
            hamburger.addEventListener('click', () => {
                const isOpen = sidebar.classList.toggle('open');
                hamburger.setAttribute('aria-expanded', isOpen);
                if (backdrop) backdrop.classList.toggle('show');
            });
        }

        if (backdrop) {
            backdrop.addEventListener('click', () => {
                sidebar.classList.remove('open');
                backdrop.classList.remove('show');
                hamburger.setAttribute('aria-expanded', 'false');
            });
        }

        // Sidebar link handler
        document.querySelectorAll('.menu-item[data-href]').forEach(item => {
            item.addEventListener('click', () => {
                const href = item.getAttribute('data-href');
                if (href) location.href = href;
            });
        });

        const map = L.map('map', { preferCanvas: true }).setView([0, 0], 3);
        const geojsonLayerGroup = L.layerGroup().addTo(map);
        const surveillanceLayerGroup = L.layerGroup().addTo(map);
        let surveillanceIndex = null;
        let surveillanceEnabled = false;
        let loadedTiles = new Set();

        const flightLayerGroup = L.layerGroup().addTo(map);
        const flightPathGroup = L.layerGroup().addTo(map);
        let flightEnabled = false;
        let flightPolling = null;
        let lastFlightData = []; // Store data for re-rendering on move
        const flightHistory = {}; // { icao24: [[lat, lng], ...] }
        const flightMarkers = {}; // { icao24: marker }
        const vesselLayerGroup = L.layerGroup().addTo(map);
        const vesselPathGroup = L.layerGroup().addTo(map);
        const vesselMarkers = {}; // { mmsi: marker }
        let vesselEnabled = false;
        let vesselPolling = null;
        let lastVesselData = []; // Store data for filtering
        let currentVesselFilter = 'all';
        const tomtomApiKey = 'ADD_API+KEY';

        // Traffic Layers
        const trafficFlowLayer = L.tileLayer(`https://{s}.api.tomtom.com/traffic/map/4/tile/flow/absolute/{z}/{x}/{y}.png?key=${tomtomApiKey}`, {
            tileSize: 256,
            zoomOffset: 0,
            opacity: 0.7
        });
        const trafficIncidentLayer = L.tileLayer(`https://{s}.api.tomtom.com/traffic/map/4/tile/incidents/s3/{z}/{x}/{y}.png?key=${tomtomApiKey}`, {
            tileSize: 256,
            zoomOffset: 0
        });
        let trafficEnabled = false;
        let trafficPolling = null;

        // Custom Cyber Icon
        const cyberIcon = L.divIcon({
            className: 'custom-cyber-marker',
            html: '<div class="marker-pulse"></div><div class="marker-core"></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        // Small pulse icon for grid drones
        const droneIcon = L.divIcon({
            className: 'custom-cyber-marker',
            html: '<div class="marker-pulse" style="width:10px; height:10px; border-color:var(--neon-pink);"></div><div class="marker-core" style="width:4px; height:4px; background:var(--neon-pink);"></div>',
            iconSize: [10, 10],
            iconAnchor: [5, 5]
        });

        const accessToken = ''; // Mapbox Token (Optional)

        // Map layers
        const layers = {
            cyberpunk: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles © Esri'
            }),
            hybrid: L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: '© Google'
            })
        };

        // Set Initial State (Cyber Mode)
        layers.cyberpunk.addTo(map);
        document.getElementById('map').classList.add('cyber-mode');

        // Layer Cycling
        const layerToggle = document.getElementById('layer-toggle');
        const layerOrder = ['cyberpunk', 'satellite', 'hybrid'];
        let currentLayerIndex = 0;

        layerToggle.addEventListener('click', () => {
            const currentKey = layerOrder[currentLayerIndex];
            map.removeLayer(layers[currentKey]);
            currentLayerIndex = (currentLayerIndex + 1) % layerOrder.length;
            const nextKey = layerOrder[currentLayerIndex];
            layers[nextKey].addTo(map);

            const mapEl = document.getElementById('map');
            if (nextKey === 'satellite') {
                mapEl.classList.remove('cyber-mode');
                document.body.classList.add('sat-mode');
                layerToggle.innerHTML = '<i class="fas fa-layer-group"></i> SATELLITE';
            } else if (nextKey === 'hybrid') {
                mapEl.classList.remove('cyber-mode');
                document.body.classList.remove('sat-mode');
                layerToggle.innerHTML = '<i class="fas fa-layer-group"></i> HYBRID';
            } else {
                mapEl.classList.add('cyber-mode');
                document.body.classList.remove('sat-mode');
                layerToggle.innerHTML = '<i class="fas fa-layer-group"></i> CYBERPUNK';
            }
        });

        function centerMapOnBot(lat, long) {
            map.setView([lat, long], 10);
            const largePopup = document.getElementById('large-popup');
            if (largePopup) largePopup.style.display = 'none';
        }

        // Weather and Traffic popup
        const largePopup = document.getElementById('large-popup');
        let clickMarker = null;

        async function showLocationInfo(lat, lng) {
            try {
                // Add marker at clicked location
                if (clickMarker) map.removeLayer(clickMarker);
                clickMarker = L.marker([lat, lng], { icon: cyberIcon }).addTo(map);

                const weatherApiKey = '03f7c36882c73928f25631bd235ebc4e';
                const weatherResponse = await axios.get(
                    `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${weatherApiKey}&units=metric`
                );

                const nominatimResponse = await axios.get(
                    `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`
                );
                const placeName = nominatimResponse.data.display_name || 'Unknown Sector';

                const tomtomApiKey = 'bCjXLonSI6Ja1jIHO726Thi6YqeDKZjK';
                const trafficResponse = await axios.get(
                    `https://api.tomtom.com/traffic/services/4/flowSegmentData/absolute/10/json?point=${lat},${lng}&key=${tomtomApiKey}`
                );

                const traffic = trafficResponse.data.flowSegmentData;
                let trafficStatus = 'FLUID';
                let trafficClass = 'active';
                let speedRatio = 100;
                let trafficDelay = 0;

                if (traffic) {
                    speedRatio = (traffic.currentSpeed / traffic.freeFlowSpeed) * 100;
                    trafficDelay = Math.max(0, 100 - speedRatio);

                    if (speedRatio < 40) {
                        trafficStatus = 'HEAVY';
                        trafficClass = 'alert';
                    } else if (speedRatio < 70) {
                        trafficStatus = 'MODERATE';
                        trafficClass = '';
                    }
                }

                // Reset accent to default for location
                largePopup.style.setProperty('--popup-accent', '#FFCC00');

                largePopup.innerHTML = `
                    <div class="large-popup-close" onclick="document.getElementById('large-popup').style.display='none'">×</div>
                    <h3>
                        <span>Location Data</span>
                        <span style="font-size:8px; color:var(--text-dim);">v9.5</span>
                    </h3>
                    <div class="popup-title">${placeName}</div>
                    <div class="popup-data">
                        <span class="data-label">COORD_X</span>
                        <span class="data-value">${lat.toFixed(4)}</span>
                        <span class="data-label">COORD_Y</span>
                        <span class="data-value">${lng.toFixed(4)}</span>
                        <span class="data-label">SYSTEM_ENV</span>
                        <span class="data-value">${weatherResponse.data.weather[0].main}</span>
                        <span class="data-label">THERMAL</span>
                        <span class="data-value">${weatherResponse.data.main.temp}°C</span>
                        
                        <div style="grid-column: span 2; margin-top: 10px; border-top: 1px solid rgba(255,204,0,0.1); padding-top: 8px;">
                            <span style="color:var(--popup-accent); font-size:9px;">TRAFFIC_UPLINK</span>
                        </div>

                        <span class="data-label">FRC_CLASS</span>
                        <span class="data-value">${traffic ? traffic.frc : 'N/A'}</span>
                        <span class="data-label">VEL_FLOW</span>
                        <span class="data-value">${traffic ? traffic.currentSpeed : 'N/A'} KM/H</span>
                        <span class="data-label">TRAFFIC_ST</span>
                        <span class="data-value ${trafficClass}">${trafficStatus}</span>
                        <span class="data-label">DELAY_ST</span>
                        <span class="data-value">${trafficDelay.toFixed(1)}%</span>

                        <div class="flow-container">
                            <div class="flow-bar" style="width: ${Math.min(100, speedRatio)}%; background: ${trafficClass === 'alert' ? '#FF2E82' : (trafficClass === 'active' ? '#00FF88' : '#FFCC00')}"></div>
                        </div>

                        <span class="data-label">STATUS</span>
                        <span class="data-value ${traffic && traffic.roadClosure ? 'alert' : 'active'}">${traffic && traffic.roadClosure ? 'OFFLINE' : 'ONLINE'}</span>
                    </div>
                    <div class="popup-footer">
                        STABLE_UPLINK || TRACE_STATUS: ACTIVE
                    </div>
                `;
                largePopup.style.display = 'block';
            } catch (error) {
                console.error('Error fetching data:', error);
                largePopup.style.display = 'none';
            }
        }



        // Coordinate Display Logic
        const coordText = document.getElementById('coord-text');
        const mapLinksMenu = document.getElementById('map-links-menu');
        const coordDisplay = document.getElementById('coord-display');
        let currentLat = 0;
        let currentLng = 0;

        // Update coordinates on click
        function updateCoordDisplay(lat, lng) {
            currentLat = lat;
            currentLng = lng;
            coordText.innerText = `LAT: ${currentLat.toFixed(5)} LON: ${currentLng.toFixed(5)}`;

            // Update links
            document.getElementById('link-google-maps').href = `https://www.google.com/maps?q=${currentLat},${currentLng}`;
            document.getElementById('link-google-earth').href = `https://earth.google.com/web/search/${currentLat},${currentLng}`;
            document.getElementById('link-osm').href = `https://www.openstreetmap.org/?mlat=${currentLat}&mlon=${currentLng}&zoom=12`;
        }

        // --- COORDINATE UPLINK (Default Popup) ---
        let coordEnabled = false;

        map.on('click', (e) => {
            // Existing logic for specific modules
            if (coordEnabled && !sentimentEnabled && !segmentEnabled && !towerEnabled && !earthNetworksEnabled) {
                showLocationInfo(e.latlng.lat, e.latlng.lng);
                updateCoordDisplay(e.latlng.lat, e.latlng.lng);
            }
        });

        document.getElementById('coord-toggle').addEventListener('change', (e) => {
            coordEnabled = e.target.checked;
            const listEl = document.getElementById('coord-active-list');
            if (listEl) listEl.style.display = coordEnabled ? 'block' : 'none';
        });

        document.getElementById('copy-coords').addEventListener('click', () => {
            const text = `${currentLat.toFixed(6)}, ${currentLng.toFixed(6)}`;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copy-coords');
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check" style="color:#00FF88"></i>';
                setTimeout(() => btn.innerHTML = original, 1000);
            });
        });

        document.getElementById('open-maps').addEventListener('click', (e) => {
            e.stopPropagation();
            mapLinksMenu.style.display = mapLinksMenu.style.display === 'flex' ? 'none' : 'flex';
        });

        // Close menu when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (mapLinksMenu.style.display === 'flex' && !coordDisplay.contains(e.target)) {
                mapLinksMenu.style.display = 'none';
            }
        });

        // Search Handlers
        document.getElementById('coord-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const [lat, lng] = e.target.value.split(',').map(Number);
                if (!isNaN(lat) && !isNaN(lng)) map.setView([lat, lng], 10);
            }
        });

        document.getElementById('place-search').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                try {
                    const response = await axios.get(`https://nominatim.openstreetmap.org/search?q=${e.target.value}&format=json`);
                    if (response.data.length > 0) {
                        const { lat, lon } = response.data[0];
                        map.setView([lat, lon], 10);
                    }
                } catch (error) { console.error(error); }
            }
        });



        // --- NEW GEOJSON RENDERING (Supports Points, Polygons, etc) ---
        function renderGeoJSONOnMap(data) {
            geojsonLayerGroup.clearLayers();
            if (!data.summary || data.summary.length === 0) return;

            const geoLayer = L.geoJSON(data.summary, {
                pointToLayer: (feature, latlng) => L.marker(latlng, { icon: cyberIcon }),
                style: {
                    color: 'var(--primary-color)',
                    weight: 2,
                    opacity: 0.8,
                    fillColor: 'var(--primary-color)',
                    fillOpacity: 0.1
                },
                onEachFeature: (feature, layer) => {
                    let html = `<div style="font-weight:bold; color:var(--primary-color); border-bottom:1px solid var(--primary-color); margin-bottom:5px;">OBJECT_DATA</div>`;
                    for (const [k, v] of Object.entries(feature.properties || {})) {
                        html += `<div class="popup-detail-item"><strong>${k}:</strong> ${v}</div>`;
                    }
                    if (feature.geometry.type === 'Point') {
                        const [lng, lat] = feature.geometry.coordinates;
                        html += `<div class="popup-detail-item"><strong>LAT/LNG:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</div>`;
                    }
                    layer.bindPopup(html);
                }
            });

            geojsonLayerGroup.addLayer(geoLayer);
            map.fitBounds(geoLayer.getBounds(), { padding: [50, 50], maxZoom: 15 });
        }

        // --- SURVEILLANCE GRID LOGIC ---
        async function updateSurveillanceGrid() {
            if (!surveillanceEnabled || !surveillanceIndex) return;

            const bounds = map.getBounds();
            const center = map.getCenter();

            // For this grid system, we load tiles based on the index
            // We'll approximate which tiles are relevant to the current view
            for (const tileId in surveillanceIndex.tiles) {
                if (loadedTiles.has(tileId)) continue;

                // Simple check: if we are zoomed in enough, load tiles
                // In a production system, we'd calculate tile bounds.
                // Here we'll just load the first few for demo if not too many.
                if (loadedTiles.size > 20) break;

                try {
                    const [z, x, y] = tileId.split('/');
                    const response = await axios.get(`/api/geo/tile/${z}/${x}/${y}`);
                    const tileData = response.data;

                    L.geoJSON(tileData, {
                        pointToLayer: (feat, ll) => L.marker(ll, { icon: droneIcon }),
                        onEachFeature: (feat, layer) => {
                            layer.bindPopup(`<div style="color:var(--neon-pink); font-weight:bold;">SURVEILLANCE_NODE</div>
                                            <div class="popup-detail-item"><strong>ID:</strong> ${feat.properties.id || 'Unknown'}</div>
                                            <div class="popup-detail-item"><strong>TYPE:</strong> ${feat.properties.type || 'CAMERA'}</div>`);
                        }
                    }).addTo(surveillanceLayerGroup);

                    loadedTiles.add(tileId);
                } catch (e) { console.error("Tile load error:", e); }
            }
        }

        document.getElementById('grid-toggle').addEventListener('change', async (e) => {
            surveillanceEnabled = e.target.checked;
            if (surveillanceEnabled) {
                if (!surveillanceIndex) {
                    const res = await axios.get('/api/geo/index');
                    surveillanceIndex = res.data;
                }
                updateSurveillanceGrid();
            } else {
                surveillanceLayerGroup.clearLayers();
                loadedTiles.clear();
            }
        });

        map.on('moveend', updateSurveillanceGrid);

        // Sidebar GeoJSON Toggles
        // --- FLIGHT TRACKER LOGIC ---
        function getFlightIcon(heading, type) {
            let color = 'var(--flight-comm)';
            let icon = 'fa-plane';

            if (type === 'military') {
                color = 'var(--flight-mil)';
                icon = 'fa-fighter-jet';
            } else if (type === 'private') {
                color = 'var(--flight-priv)';
                icon = 'fa-plane-departure';
            } else if (type === 'emergency') {
                color = 'var(--flight-emer)';
                icon = 'fa-plus-square';
            }

            return L.divIcon({
                className: 'flight-icon-container',
                html: `<i class="fas ${icon}" style="transform: rotate(${heading - (icon === 'fa-fighter-jet' ? 0 : 45)}deg); font-size: 14px; color: ${color}; text-shadow: 0 0 10px ${color};"></i>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
        }

        let currentFlightFilter = 'all';

        function renderFlights() {
            if (!flightEnabled || !lastFlightData.length) return;

            const zoom = map.getZoom();
            const bounds = map.getBounds().pad(0.2);
            const currentIcaoSet = new Set();

            // Filter data based on selection
            const filteredData = lastFlightData.filter(f => {
                if (currentFlightFilter === 'all') return true;
                if (currentFlightFilter === 'military') return f.type === 'military';
                if (currentFlightFilter === 'private') return f.type === 'private';
                if (currentFlightFilter === 'emergency') return f.type === 'emergency';
                if (currentFlightFilter === 'airline') {
                    // Commercial/Airline is anything that isn't the special types
                    return f.type !== 'military' && f.type !== 'private' && f.type !== 'emergency';
                }
                return true;
            });

            filteredData.forEach((f) => {
                const icao = f.icao24;
                const pos = [f.lat, f.long];

                const inBounds = bounds.contains(pos);

                if (!inBounds) {
                    if (flightMarkers[icao]) {
                        flightLayerGroup.removeLayer(flightMarkers[icao]);
                        delete flightMarkers[icao];
                    }
                    return;
                }

                currentIcaoSet.add(icao);

                if (flightMarkers[icao]) {
                    if (zoom < 7 && flightMarkers[icao] instanceof L.CircleMarker) {
                        flightMarkers[icao].setLatLng(pos);
                    } else if (zoom >= 7 && flightMarkers[icao] instanceof L.Marker) {
                        flightMarkers[icao].setLatLng(pos);
                        flightMarkers[icao].setIcon(getFlightIcon(f.heading, f.type));
                    } else {
                        flightLayerGroup.removeLayer(flightMarkers[icao]);
                        delete flightMarkers[icao];
                    }
                }

                if (!flightMarkers[icao]) {
                    let marker;
                    if (zoom < 7) {
                        let color = '#00FFD1';
                        if (f.type === 'military') color = '#FF4400';
                        else if (f.type === 'private') color = '#FF00FF';
                        else if (f.type === 'emergency') color = '#FFFFFF';

                        marker = L.circleMarker(pos, {
                            radius: 3,
                            fillColor: color,
                            color: '#000',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    } else {
                        marker = L.marker(pos, { icon: getFlightIcon(f.heading, f.type) });
                    }

                    marker.bindPopup(() => {
                        return `
                        <div id="popup-${icao}">
                            <div style="color:var(--cyberpunk-blue); font-weight:bold; border-bottom:1px solid var(--cyberpunk-blue); margin-bottom:5px;">UPLINK: ${f.icao24.toUpperCase()}</div>
                            <div class="popup-detail-item"><strong>CALLSIGN:</strong> ${f.callsign}</div>
                            <div class="popup-detail-item"><strong>REG:</strong> ${f.registration || '---'}</div>
                            <div class="popup-detail-item"><strong>TYPE:</strong> ${f.aircraft_type || '---'}</div>
                            <div class="popup-detail-item"><strong>SQUAWK:</strong> ${f.squawk || '----'}</div>
                            <div class="popup-detail-item"><strong>ALT:</strong> ${Math.round(f.alt || 0)}ft | <strong>SPD:</strong> ${Math.round(f.velocity || 0)}kts</div>
                            <div class="popup-detail-item"><strong>HDG:</strong> ${Math.round(f.heading || 0)}° | <strong>CLASS:</strong> ${f.type.toUpperCase()}</div>
                            <div style="margin-top:8px; display:flex; gap:10px;">
                                <a href="https://www.flightradar24.com/${f.callsign}" target="_blank" class="external-link"><i class="fas fa-external-link-alt"></i> FR24</a>
                                <a href="https://globe.adsbexchange.com/?icao=${f.icao24}" target="_blank" class="external-link"><i class="fas fa-external-link-alt"></i> ADSB</a>
                            </div>
                        </div>`;
                    });

                    marker.on('click', () => {
                        flightPathGroup.clearLayers();
                        if (flightHistory[icao] && flightHistory[icao].length > 1) {
                            L.polyline(flightHistory[icao], {
                                color: '#00A3FF',
                                weight: 3,
                                opacity: 0.8,
                                dashArray: '8, 4',
                                className: 'flight-path'
                            }).addTo(flightPathGroup);
                        }
                    });

                    marker.addTo(flightLayerGroup);
                    flightMarkers[icao] = marker;
                }
            });

            for (const icao in flightMarkers) {
                if (!currentIcaoSet.has(icao)) {
                    flightLayerGroup.removeLayer(flightMarkers[icao]);
                    delete flightMarkers[icao];
                }
            }
        }

        async function updateFlightTracker() {
            if (!flightEnabled) return;

            try {
                const res = await axios.get('/api/geo/flights');
                const flights = res.data;
                lastFlightData = flights;

                console.log('Flights received:', flights.length);

                const listEl = document.getElementById('flights-active-list');
                if (listEl) {
                    if (flights.error) {
                        console.error('Flight API Error:', flights.error);
                        listEl.innerHTML = `<div class="log-entry alert" style="padding: 5px;">API_ERROR: ${flights.error}</div>`;
                        return;
                    }

                    if (flights.length > 0) {
                        listEl.innerHTML = `<div style="padding: 5px; color: var(--cyberpunk-blue); border-bottom: 1px solid rgba(0,255,209,0.1);">ACTIVE_UPLINKS: ${flights.length}</div>`;
                        flights.slice(0, 50).forEach(f => {
                            const item = document.createElement('div');
                            item.className = 'geojson-item';
                            item.style.fontSize = '9px';
                            item.style.padding = '2px 10px';
                            item.style.cursor = 'pointer';
                            const typeIcon = f.type === 'military' ? '🚁' : (f.type === 'private' ? '🛫' : '✈️');
                            item.innerHTML = `<span style="color:var(--cyberpunk-blue)">[${f.icao24.toUpperCase()}]</span> ${typeIcon} ${f.callsign}`;
                            item.onclick = () => {
                                map.setView([f.lat, f.long], 10);
                                if (flightMarkers[f.icao24]) flightMarkers[f.icao24].openPopup();
                            };
                            listEl.appendChild(item);
                        });
                    } else {
                        listEl.innerHTML = `<div class="log-entry warn" style="padding: 5px;">NO_AIRCRAFT_DETECTED</div>`;
                    }
                }

                // Update flight history
                flights.forEach(f => {
                    const icao = f.icao24;
                    const pos = [f.lat, f.long];
                    if (!flightHistory[icao]) flightHistory[icao] = [];
                    flightHistory[icao].push(pos);
                    if (flightHistory[icao].length > 100) flightHistory[icao].shift();
                });

                renderFlights();

            } catch (err) { console.error("Flight Tracker Error:", err); }
        }

        document.getElementById('flight-toggle').addEventListener('change', (e) => {
            flightEnabled = e.target.checked;
            document.getElementById('map-legend').style.display = flightEnabled ? 'block' : 'none';
            document.getElementById('flights-active-list').style.display = flightEnabled ? 'block' : 'none';
            if (flightEnabled) {
                updateFlightTracker();
                flightPolling = setInterval(updateFlightTracker, 30000); // 30s interval for better performance
            } else {
                clearInterval(flightPolling);
                flightLayerGroup.clearLayers();
                flightPathGroup.clearLayers();
                lastFlightData = [];
                for (const key in flightMarkers) delete flightMarkers[key];
                document.getElementById('flights-active-list').innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px;">AWAITING_SKYSCAN_LINK...</div>';
            }
        });

        // Flight Filter Event Listeners
        document.querySelectorAll('.flight-filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Update UI
                document.querySelectorAll('.flight-filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');

                // Update Filter
                currentFlightFilter = e.target.getAttribute('data-filter');
                console.log('Flight Filter Changed to:', currentFlightFilter);

                // Re-render
                renderFlights();
            });
        });

        // --- TOMTOM TRAFFIC LOGIC ---
        async function updateTrafficData() {
            if (!trafficEnabled) return;

            try {
                // Fetch incidents for current view
                const bounds = map.getBounds();
                const bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;

                // Note: TomTom Incident API requires bbox or point. 
                // We'll use the incident metadata API if available, 
                // but since the user asked for "HTML" traffic dat, we'll try to fetch some details.
                // For simplicity and to show data in sidebar, 
                // we'll use a mocked or simplified incident summary if the primary API is complex.
                // TomTom Traffic Flow Segment Data for the center point is another option.

                const center = map.getCenter();
                const res = await axios.get(`https://api.tomtom.com/traffic/services/4/flowSegmentData/absolute/10/json?point=${center.lat},${center.lng}&key=${tomtomApiKey}`);
                const data = res.data.flowSegmentData;

                const listEl = document.getElementById('traffic-active-list');
                if (listEl && data) {
                    listEl.innerHTML = `<div style="padding: 5px; color: #FFA600; border-bottom: 1px solid rgba(255,166,0,0.1);">ZONE_TRAFFIC_STATUS</div>`;

                    const item = document.createElement('div');
                    item.className = 'geojson-item';
                    item.style.fontSize = '9px';
                    item.style.padding = '5px 10px';

                    let status = 'FLUID';
                    let color = '#00FF88';
                    if (data.currentSpeed < data.freeFlowSpeed * 0.4) {
                        status = 'HEAVY';
                        color = '#FF4444';
                    } else if (data.currentSpeed < data.freeFlowSpeed * 0.7) {
                        status = 'MODERATE';
                        color = '#FFA600';
                    }

                    item.innerHTML = `
                        <div style="color:${color}">[${status}] ${data.currentSpeed} KM/H</div>
                        <div style="color:var(--text-dim)">FLOW: ${data.freeFlowSpeed} KM/H</div>
                        <div style="color:var(--text-dim); margin-top:2px;">FRC: ${data.frc} | CONF: ${Math.round(data.confidence * 100)}%</div>
                    `;
                    listEl.appendChild(item);

                    // Add secondary info if available
                    if (data.roadClosure) {
                        const closure = document.createElement('div');
                        closure.className = 'log-entry alert';
                        closure.style.fontSize = '9px';
                        closure.style.margin = '2px 10px';
                        closure.innerText = 'ROAD_CLOSURE_DETECTED';
                        listEl.appendChild(closure);
                    }
                }
            } catch (err) { console.error("Traffic Data Error:", err); }
        }

        document.getElementById('traffic-toggle').addEventListener('change', (e) => {
            trafficEnabled = e.target.checked;
            document.getElementById('traffic-active-list').style.display = trafficEnabled ? 'block' : 'none';
            if (trafficEnabled) {
                trafficFlowLayer.addTo(map);
                trafficIncidentLayer.addTo(map);
                updateTrafficData();
                trafficPolling = setInterval(updateTrafficData, 60000);
            } else {
                clearInterval(trafficPolling);
                map.removeLayer(trafficFlowLayer);
                map.removeLayer(trafficIncidentLayer);
                document.getElementById('traffic-active-list').innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px;">AWAITING_TRAFFIC_LINK...</div>';
            }
        });

        map.on('moveend', () => {
            if (trafficEnabled) updateTrafficData();
        });

        // --- VESSEL TRACKER LOGIC ---
        function getVesselIcon(type, heading) {
            let color = '#AAA'; // Default
            if (type === 'cargo') color = '#00CCFF';
            else if (type === 'tanker') color = '#FF4444';
            else if (type === 'passenger') color = '#00FF88';
            else if (type === 'fishing') color = '#FFAA00';
            else if (type === 'pilot' || type === 'tug') color = '#FFFF00';
            else if (type === 'military' || type === 'milt') color = '#FF4400';

            return L.divIcon({
                className: 'vessel-icon-container',
                html: `<i class="fas fa-ship" style="transform: rotate(${heading}deg); font-size: 14px; color: ${color};"></i>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
        }

        async function updateVesselTracker() {
            if (!vesselEnabled) return;

            try {
                // Get current map bounds for the backend query
                const bounds = map.getBounds();
                const boundsStr = `${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()},${bounds.getWest()}`;

                const res = await axios.get(`/api/geo/vessels?bounds=${boundsStr}`);
                const vessels = res.data;
                lastVesselData = vessels;

                renderVessels();
            } catch (err) { console.error("Vessel Tracker Error:", err); }
        }

        function renderVessels() {
            if (!vesselEnabled) return;

            const listEl = document.getElementById('vessels-active-list');
            const searchType = document.getElementById('ship-search-type').value;
            const query = document.getElementById('ship-search-input').value.trim().toLowerCase();

            // Filter
            const filtered = lastVesselData.filter(v => {
                // Category Filter
                if (currentVesselFilter !== 'all') {
                    if (currentVesselFilter === 'military' && (v.type !== 'military' && v.type !== 'milt')) return false;
                    if (currentVesselFilter !== 'military' && v.type !== currentVesselFilter) return false;
                }

                // Text Filter
                if (!query) return true;
                if (searchType === 'name') return (v.name || '').toLowerCase().includes(query);
                if (searchType === 'mmsi') return (v.mmsi || '').toString().includes(query);
                return true;
            });

            if (listEl) {
                listEl.innerHTML = `<div style="padding: 5px; color: #00FF88; border-bottom: 1px solid rgba(0,255,136,0.1);">ACTIVE_VESSELS: ${filtered.length}</div>`;
                filtered.slice(0, 50).forEach(v => {
                    const item = document.createElement('div');
                    item.className = 'geojson-item';
                    item.style.fontSize = '9px';
                    item.style.padding = '2px 10px';
                    item.style.cursor = 'pointer';

                    let typeIcon = '🚢'; // Default
                    if (v.type === 'fishing') typeIcon = '🎣';
                    else if (v.type === 'passenger') typeIcon = '🛳️';
                    else if (v.type === 'tanker') typeIcon = '🛢️';
                    else if (v.type === 'military' || v.type === 'milt') typeIcon = '⚓';

                    item.innerHTML = `<span style="color:#00FF88">[${v.mmsi}]</span> ${typeIcon} ${v.name}`;
                    item.onclick = () => {
                        map.setView([v.lat, v.lon], 10);
                        if (vesselMarkers[v.mmsi]) vesselMarkers[v.mmsi].fire('click');
                    };
                    listEl.appendChild(item);
                });
            }

            const currentMmsiSet = new Set();
            filtered.forEach(v => {
                currentMmsiSet.add(v.mmsi);
                if (vesselMarkers[v.mmsi]) {
                    vesselMarkers[v.mmsi].setLatLng([v.lat, v.lon]);
                    vesselMarkers[v.mmsi].setIcon(getVesselIcon(v.type, v.heading));
                } else {
                    const marker = L.marker([v.lat, v.lon], { icon: getVesselIcon(v.type, v.heading) });

                    marker.on('click', async () => {
                        // Show path using UID if available, fallback to MMSI
                        vesselPathGroup.clearLayers();
                        try {
                            const pathId = v.uid || v.mmsi;
                            const pathRes = await axios.get(`/api/geo/vessel/path/${pathId}`);
                            if (pathRes.data && pathRes.data.length > 0) {
                                L.polyline(pathRes.data, { color: '#00FF88', weight: 2, dashArray: '5, 5' }).addTo(vesselPathGroup);
                            }
                        } catch (e) { console.error(e); }

                        // Show detailed popup with proper ship type colors
                        const vesselColors = {
                            'cargo': '#00CCFF',
                            'tanker': '#FF4444',
                            'passenger': '#00FF88',
                            'fishing': '#FFAA00',
                            'pilot': '#FFFF00',
                            'tug': '#FFFF00',
                            'pleasure': '#FF00FF',
                            'sailing': '#00DDFF',
                            'military': '#FF4400',
                            'milt': '#FF4400',
                            'law': '#FFA500',
                            'special': '#FFCC00',
                            'reserved': '#888888'
                        };
                        const accentColor = vesselColors[v.type] || '#FFCC00';
                        largePopup.style.setProperty('--popup-accent', accentColor);

                        // Get country flag emoji
                        const getCountryFlag = (country) => {
                            const flags = {
                                'PA': '🇵🇦', 'IN': '🇮🇳', 'LR': '🇱🇷', 'MH': '🇲🇭', 'MT': '🇲🇹',
                                'SG': '🇸🇬', 'HK': '🇭🇰', 'US': '🇺🇸', 'GB': '🇬🇧', 'CN': '🇨🇳',
                                'JP': '🇯🇵', 'KR': '🇰🇷', 'GR': '🇬🇷', 'CY': '🇨🇾', 'BM': '🇧🇲',
                                'BS': '🇧🇸', 'NO': '🇳🇴', 'DK': '🇩🇰', 'NL': '🇳🇱', 'DE': '🇩🇪'
                            };
                            return flags[country?.toUpperCase()] || '🏴';
                        };

                        // Get ship type emoji
                        const getShipTypeEmoji = (type) => {
                            const emojis = {
                                'cargo': '📦',
                                'tanker': '🛢️',
                                'passenger': '🛳️',
                                'fishing': '🎣',
                                'pilot': '🚤',
                                'tug': '🚢',
                                'military': '⚓',
                                'milt': '⚓',
                                'sailing': '⛵',
                                'pleasure': '🛥️'
                            };
                            return emojis[type?.toLowerCase()] || '🚢';
                        };

                        largePopup.innerHTML = `
                            <div class="large-popup-close" onclick="document.getElementById('large-popup').style.display='none'">×</div>
                            <h3>
                                <span style="display:flex; align-items:center; gap:5px;">
                                    <i class="fas fa-satellite-dish" style="color:var(--neon-blue); font-size:10px;"></i>
                                    AIS UPLINK_v10.0
                                </span>
                                <span class="ais-badge" style="background:#00FF88; color:#000; padding:2px 4px; border-radius:3px; font-size:7px; font-weight:bold;">LIVE_AIS</span>
                            </h3>
                            <div class="popup-title" style="color: ${accentColor}; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                <span style="font-size:24px;">${getCountryFlag(v.country)}</span>
                                <span style="flex:1;">${v.name}</span>
                                <span style="background:${accentColor}; color:#000; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:bold;">
                                    ${getShipTypeEmoji(v.type)} ${v.type.toUpperCase()}
                                </span>
                            </div>
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <div style="width:100px; height:60px; background:#1a1a1a; display:flex; align-items:center; justify-content:center; border:1px solid ${accentColor};">
                                    <i class="fas fa-ship" style="font-size:30px; color:${accentColor}"></i>
                                </div>
                                <div class="popup-data" style="padding:0; grid-template-columns: 1fr 1fr;">
                                    <span class="data-label">MMSI</span> <span class="data-value">${v.mmsi}</span>
                                    <span class="data-label">IMO</span> <span class="data-value">${v.imo}</span>
                                    <span class="data-label">CALL</span> <span class="data-value" style="color:#00FFFF">${v.callsign}</span>
                                    <span class="data-label">TYPE</span> <span class="data-value" style="color: ${accentColor}">${v.type.toUpperCase()}</span>
                                </div>
                            </div>
                            <div class="popup-data">
                                <span class="data-label">FLAG</span> <span class="data-value">${getCountryFlag(v.country)} ${v.country}</span>
                                <span class="data-label">STATUS</span> <span class="data-value">${v.status}</span>
                                <span class="data-label">NAV_DEST</span> <span class="data-value">${v.arrival}</span>
                                <span class="data-label">VEL_SPD</span> <span class="data-value">${v.speed.toFixed(1)} KTS</span>
                                <span class="data-label">HEADING</span> <span class="data-value">${v.heading}°</span>
                            </div>
                            <div style="margin-top:10px; padding:8px; background:rgba(0,255,136,0.05); border:1px solid rgba(0,255,136,0.2); border-radius:4px;">
                                <div style="font-size:9px; color:var(--text-dim); margin-bottom:5px;">EXTERNAL TRACKING:</div>
                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <a href="https://www.marinetraffic.com/en/ais/details/ships/mmsi:${v.mmsi}" target="_blank" 
                                       style="flex:1; padding:6px 10px; background:#0066CC; color:#fff; text-decoration:none; border-radius:3px; font-size:10px; text-align:center; font-weight:bold;">
                                        📊 MarineTraffic
                                    </a>
                                    <a href="https://www.vesselfinder.com/vessels/details/${v.mmsi}" target="_blank"
                                       style="flex:1; padding:6px 10px; background:#00AA66; color:#fff; text-decoration:none; border-radius:3px; font-size:10px; text-align:center; font-weight:bold;">
                                        🌊 VesselFinder
                                    </a>
                                    <a href="https://www.fleetmon.com/vessels/?s=${v.name}" target="_blank"
                                       style="flex:1; padding:6px 10px; background:#FF6600; color:#fff; text-decoration:none; border-radius:3px; font-size:10px; text-align:center; font-weight:bold;">
                                        🚢 FleetMon
                                    </a>
                                </div>
                            </div>
                            <div class="popup-footer" style="color:var(--text-dim); border-top: 1px solid rgba(255,255,255,0.05); padding-top:5px; display:flex; justify-content:space-between; margin-top:10px;">
                                <span>${v.source}</span>
                                <span>PATH_LINK: ACTIVE</span>
                            </div>
                        `;
                        largePopup.style.display = 'block';
                    });

                    marker.addTo(vesselLayerGroup);
                    vesselMarkers[v.mmsi] = marker;
                }
            });

            // Cleanup old markers
            for (const mmsi in vesselMarkers) {
                if (!currentMmsiSet.has(parseInt(mmsi)) && !currentMmsiSet.has(mmsi)) {
                    vesselLayerGroup.removeLayer(vesselMarkers[mmsi]);
                    delete vesselMarkers[mmsi];
                }
            }
        }

        // Ship search listeners
        document.getElementById('ship-search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') renderVessels();
        });
        document.getElementById('ship-search-input').addEventListener('input', renderVessels);
        document.getElementById('ship-search-type').addEventListener('change', renderVessels);

        // Vessel buttons logic
        document.querySelectorAll('.vessel-filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // UI Toggle
                document.querySelectorAll('.vessel-filter-btn').forEach(b => b.classList.remove('active'));
                // Retain logic for specific styling (re-applying active style manually or via class if CSS existed)
                // Since we used inline styles, we just add a visual indicator or handle custom class
                // For simplicity, let's just use the 'active' class which likely needs CSS backing or manual style swap
                // We'll trust the 'active' class exists or add simple border highlight
                e.target.classList.add('active');

                // Reset backgrounds
                document.querySelectorAll('.vessel-filter-btn').forEach(b => {
                    b.style.background = b.getAttribute('data-filter') === 'all' ? 'rgba(0, 255, 136, 0.2)' :
                        b.getAttribute('data-filter') === 'cargo' ? 'rgba(0, 204, 255, 0.1)' :
                            b.getAttribute('data-filter') === 'tanker' ? 'rgba(255, 68, 68, 0.1)' :
                                b.getAttribute('data-filter') === 'military' ? 'rgba(255, 68, 0, 0.1)' :
                                    'rgba(255, 170, 0, 0.1)';
                    b.style.boxShadow = 'none';
                });
                // Highlight active
                e.target.style.background = 'rgba(255, 255, 255, 0.2)';
                e.target.style.boxShadow = `0 0 5px ${e.target.style.color}`;

                currentVesselFilter = e.target.getAttribute('data-filter');
                renderVessels();
            });
        });


        document.getElementById('vessel-toggle').addEventListener('change', (e) => {
            vesselEnabled = e.target.checked;
            document.getElementById('vessels-active-list').style.display = vesselEnabled ? 'block' : 'none';
            if (vesselEnabled) {
                updateVesselTracker();
                vesselPolling = setInterval(updateVesselTracker, 30000);
            } else {
                clearInterval(vesselPolling);
                vesselLayerGroup.clearLayers();
                vesselPathGroup.clearLayers();
                for (const key in vesselMarkers) delete vesselMarkers[key];
                document.getElementById('vessels-active-list').innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px;">AWAITING_VESSEL_LINK...</div>';
            }
        });

        // Add moveend listener for high-performance rendering
        map.on('moveend', renderFlights);
        map.on('zoomend', renderFlights);

        // Advanced Search Handler
        document.getElementById('advanced-search').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const type = document.getElementById('search-type').value;
                const query = e.target.value.trim();
                if (!query) return;

                // Ensure flight tracker is enabled if searching for flights
                if (!flightEnabled) {
                    document.getElementById('flight-toggle').checked = true;
                    document.getElementById('flight-toggle').dispatchEvent(new Event('change'));
                }

                try {
                    const res = await axios.get(`/api/geo/flights?q=${query}`);
                    if (res.data.length > 0) {
                        const f = res.data[0];
                        map.setView([f.lat, f.long], 10);
                        updateFlightTracker();
                        setTimeout(() => {
                            if (flightMarkers[f.icao24]) flightMarkers[f.icao24].openPopup();
                        }, 1000);
                    } else {
                        // Fallback to nominatim for location search if not a specific flight query
                        if (type !== 'hex' && type !== 'call' && type !== 'reg' && type !== 'type') {
                            const response = await axios.get(`https://nominatim.openstreetmap.org/search?q=${query}&format=json`);
                            if (response.data.length > 0) {
                                const { lat, lon } = response.data[0];
                                map.setView([lat, lon], 12);
                            }
                        }
                    }
                } catch (err) { console.error("Search error", err); }
            }
        });


        // --- SENTIMENT / NEWS LOGIC ---
        let sentimentEnabled = false;

        async function fetchSentimentData(lat, lng) {
            const largePopup = document.getElementById('large-popup');
            largePopup.style.display = 'block';
            largePopup.innerHTML = `
                <div class="large-popup-close" onclick="document.getElementById('large-popup').style.display='none'">×</div>
                <div style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
                    <h3 style="border-color:var(--neon-cyan); position:sticky; top:0; background:rgba(0,10,10,0.95); z-index:10; padding-top:10px; margin-top:0;">
                        <span>GLOBAL_SENTIMENT</span>
                        <span style="font-size:8px; color:var(--text-dim);">Scanning...</span>
                    </h3>
                    <div style="padding:20px; text-align:center; color:var(--neon-cyan);">
                        <i class="fas fa-satellite-dish fa-spin" style="font-size:24px; margin-bottom:10px;"></i><br>
                        INTERCEPTING_REGIONAL_COMMS...
                    </div>
                </div>
            `;

            try {
                const res = await axios.get(`/api/geo/news?lat=${lat}&lon=${lng}`);
                const data = res.data;

                if (data.error) throw new Error(data.error);

                const sentimentColor = data.sentiment.label === 'CRITICAL' ? '#FF2E82' :
                    (data.sentiment.label === 'STABLE' ? '#00FF88' : '#FFA600');

                largePopup.style.setProperty('--popup-accent', sentimentColor);

                let tweetsHtml = '';
                data.tweets.forEach(t => {
                    tweetsHtml += `
                        <div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.1);">
                            <div style="display:flex; justify-content:space-between; color:var(--cyberpunk-blue); font-size:9px;">
                                <strong>${t.user}</strong>
                                <span>${t.timestamp}</span>
                            </div>
                            <div style="color:#ddd; font-size:10px; margin-top:2px;">${t.text}</div>
                        </div>
                    `;
                });

                let newsHtml = '';
                if (data.news && data.news.length > 0) {
                    data.news.forEach(n => {
                        newsHtml += `
                            <div style="margin-bottom:6px; font-size:10px;">
                                <span style="color:${sentimentColor};">[${n.source}]</span> 
                                <span style="color:#fff;">${n.title}</span>
                                <span style="color:var(--text-dim); font-size:8px;">${n.time}</span>
                            </div>
                        `;
                    });
                } else {
                    newsHtml = '<div style="color:#777; font-size:9px; font-style:italic; padding:10px;">NO_INTEL_REPORTS</div>';
                }

                // Final render with news content
                largePopup.innerHTML = `
                    <div class="large-popup-close" onclick="document.getElementById('large-popup').style.display='none'">×</div>
                    <div style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
                        <h3 style="border-color:${sentimentColor}; position:sticky; top:0; background:rgba(0,0,0,0.95); z-index:10; padding-top:10px; margin-top:0;">
                            <span>GLOBAL_SENTIMENT</span>
                            <span style="border:1px solid ${sentimentColor}; padding:2px 5px; color:${sentimentColor}; font-size:9px;">${data.sentiment.label}</span>
                        </h3>
                        
                        <div class="popup-data" style="margin-bottom:10px;">
                             <span class="data-label">SCORE</span>
                             <span class="data-value" style="color:${sentimentColor}">${data.sentiment.score}</span>
                             <span class="data-label">TREND</span>
                             <span class="data-value">${data.sentiment.trend}</span>
                        </div>
                    
                        <div style="font-size:9px; color:var(--popup-accent); margin-bottom:10px; border:1px solid var(--popup-accent); padding:5px;">
                            ${data.intel_summary}
                        </div>
                        
                        <div style="margin-bottom:10px;">
                            <div style="font-size:9px; color:var(--neon-cyan); margin-bottom:5px; border-bottom:1px solid var(--neon-cyan);">INTERCEPTED_TWEETS</div>
                            <div style="max-height:150px; overflow-y:auto; overflow-x:hidden;">
                                ${tweetsHtml}
                            </div>
                        </div>
                        
                        <div>
                            <div style="font-size:9px; color:var(--neon-cyan); margin-bottom:5px; border-bottom:1px solid var(--neon-cyan);">REGIONAL_NEWS_FEED</div>
                            ${newsHtml}
                        </div>
                        
                        <div class="popup-footer">
                            INTELLIGENCE_SOURCE: CLASSIFIED
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error(err);
                largePopup.innerHTML = `
                    <div class="large-popup-close" onclick="document.getElementById('large-popup').style.display='none'">×</div>
                    <h3 style="color:#FF4444; border-color:#FF4444;">CONNECTION_LOST</h3>
                    <div style="padding:10px; color:#FF4444; font-size:10px;">
                        UNABLE TO ESTABLISH UPLINK TO NEWS SERVER.<br>
                        ${err.message || 'UNKNOWN_ERROR'}
                    </div>
                `;
            }
        }




        const onMapClickForSentiment = (e) => {
            if (sentimentEnabled) fetchSentimentData(e.latlng.lat, e.latlng.lng);
        };

        document.getElementById('sentiment-toggle').addEventListener('change', (e) => {
            sentimentEnabled = e.target.checked;
            if (sentimentEnabled) {
                map.on('click', onMapClickForSentiment);
                // Optionally disable other click interactions or show a toast
                const listEl = document.getElementById('sentiment-active-list');
                if (listEl) listEl.style.display = 'block';
            } else {
                map.off('click', onMapClickForSentiment);
                const listEl = document.getElementById('sentiment-active-list');
                if (listEl) listEl.style.display = 'none';
            }
        });

        // --- CELL TOWER TRACKING LOGIC ---
        const towerLayerGroup = L.layerGroup().addTo(map);
        let towerEnabled = false;
        let towerPolling = null;
        let lastTowerData = [];

        async function updateTowerTracker(lat, lon) {
            if (!towerEnabled) return;

            try {
                // Use the click coordinates if provided, otherwise default to map center (though click is preferred now)
                const queryLat = lat || map.getCenter().lat;
                const queryLon = lon || map.getCenter().lng;

                const res = await axios.get(`/api/geo/celltower?lat=${queryLat}&lon=${queryLon}`);
                const towers = res.data;
                lastTowerData = towers;

                renderTowers();
            } catch (err) { console.error("Tower Tracker Error:", err); }
        }

        function renderTowers() {
            if (!towerEnabled) return;

            const listEl = document.getElementById('towers-active-list');
            // We clear previous layers to reduce load as requested ("reduce load")
            towerLayerGroup.clearLayers();

            if (listEl) {
                if (lastTowerData.error) {
                    listEl.innerHTML = `<div class="log-entry alert" style="padding: 5px;">API_ERROR: ${lastTowerData.error}</div>`;
                    return;
                }

                const towerCount = Array.isArray(lastTowerData) ? lastTowerData.length : (lastTowerData ? 1 : 0);

                listEl.innerHTML = `<div style="padding: 5px; color: var(--neon-purple); border-bottom: 1px solid rgba(188, 19, 254, 0.1);">ACTIVE_TOWERS: ${towerCount}</div>`;

                if (Array.isArray(lastTowerData)) {
                    lastTowerData.forEach(t => {
                        const item = document.createElement('div');
                        item.className = 'geojson-item';
                        item.style.fontSize = '9px';
                        item.style.padding = '2px 10px';
                        item.style.cursor = 'pointer';
                        item.innerHTML = `<span style="color:var(--neon-purple)">[${t.id}]</span> <i class="fas fa-broadcast-tower"></i> ${t.radio.toUpperCase()} (${t.mcc}-${t.mnc})`;
                        item.onclick = (e) => {
                            e.stopPropagation(); // Prevent map click
                            map.setView([t.lat, t.lon], 13);
                            L.popup()
                                .setLatLng([t.lat, t.lon])
                                .setContent(`<div style="color:var(--neon-purple); font-weight:bold;">CELL_ID: ${t.id}</div>`)
                                .openOn(map);
                        };
                        listEl.appendChild(item);

                        // Map Marker
                        const icon = L.divIcon({
                            className: 'custom-cyber-marker',
                            html: '<div class="marker-pulse" style="border-color:var(--neon-purple);"></div><div class="marker-core" style="background:var(--neon-purple);"></div>',
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        });

                        L.marker([t.lat, t.lon], { icon: icon })
                            .bindPopup(`
                            <div style="color:var(--neon-purple); font-weight:bold; border-bottom:1px solid var(--neon-purple); margin-bottom:5px;">CELL_TOWER_UPLINK</div>
                            <div class="popup-detail-item"><strong>ID:</strong> ${t.id}</div>
                            <div class="popup-detail-item"><strong>RADIO:</strong> ${t.radio.toUpperCase()}</div>
                            <div class="popup-detail-item"><strong>MCC-MNC:</strong> ${t.mcc}-${t.mnc}</div>
                            <div class="popup-detail-item"><strong>LAC:</strong> ${t.lac}</div>
                            <div class="popup-detail-item"><strong>SIGNAL:</strong> ${t.signal || 'N/A'}</div>
                         `)
                            .addTo(towerLayerGroup);
                    });
                }
            }
        }

        const onMapClickForTowers = (e) => {
            if (towerEnabled) {
                updateTowerTracker(e.latlng.lat, e.latlng.lng);
            }
        };

        document.getElementById('tower-toggle').addEventListener('change', (e) => {
            towerEnabled = e.target.checked;
            document.getElementById('towers-active-list').style.display = towerEnabled ? 'block' : 'none';
            if (towerEnabled) {
                document.getElementById('towers-active-list').innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px;">CLICK_MAP_TO_SCAN...</div>';
                map.on('click', onMapClickForTowers);
            } else {
                map.off('click', onMapClickForTowers);
                towerLayerGroup.clearLayers();
                document.getElementById('towers-active-list').innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px;">AWAITING_TOWER_LINK...</div>';
            }
        });

        // --- EARTH NETWORKS (WiFi/BT) LOGIC ---
        const earthNetworksLayerGroup = L.layerGroup().addTo(map);
        let earthNetworksEnabled = false;
        let lastEarthNetworksData = [];

        async function updateEarthNetworks(lat, lon) {
            if (!earthNetworksEnabled) return;

            const listEl = document.getElementById('earth-networks-active-list');
            listEl.innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px; color:var(--primary-color);">SCANNING_FOR_NETWORKS...</div>';

            try {
                const res = await axios.get(`/earthnetworks?lat=${lat}&lon=${lon}`);
                const data = res.data;

                if (data.success && data.results) {
                    lastEarthNetworksData = data.results;
                    renderEarthNetworks();
                } else {
                    listEl.innerHTML = `<div class="log-entry warn" style="padding: 5px; font-size: 10px;">NO_NETWORKS_FOUND</div>`;
                }
            } catch (err) {
                console.error("Earth Networks Error:", err);
                let msg = err.message;
                if (err.response && err.response.data) {
                    if (err.response.data.error === "RATE_LIMIT_EXCEEDED") {
                        msg = "UPLINK_QUOTA_EXHAUSTED: Try again in 24h";
                    } else if (err.response.data.error) {
                        msg = `${err.response.data.error}: ${err.response.data.message || ''}`;
                    }
                }
                listEl.innerHTML = `<div class="log-entry warn" style="padding: 5px; font-size: 10px; border-left: 2px solid var(--neon-pink);">${msg.substring(0, 100)}</div>`;
            }
        }

        function getDeviceType(ssid, netType) {
            const s = ssid.toLowerCase();
            if (s.includes('tv') || s.includes('samsung') || s.includes('sony') || s.includes('lg') || s.includes('vizio') || s.includes('roku')) return 'TV';
            if (s.includes('cctv') || s.includes('camera') || s.includes('cam') || s.includes('surveillance') || s.includes('hikvision') || s.includes('dahua')) return 'CCTV';
            if (s.includes('car') || s.includes('tesla') || s.includes('bmw') || s.includes('audi') || s.includes('ford') || s.includes('toyota') || s.includes('obd')) return 'CAR';
            if (s.includes('headphone') || s.includes('beats') || s.includes('bose') || s.includes('jbl') || s.includes('airpods') || s.includes('buds')) return 'HEADPHONES';
            return netType === 'bluetooth' ? 'BLUETOOTH' : 'WIFI';
        }

        function getDeviceIcon(type) {
            switch (type) {
                case 'TV': return 'fas fa-tv';
                case 'CCTV': return 'fas fa-video';
                case 'CAR': return 'fas fa-car';
                case 'HEADPHONES': return 'fas fa-headphones';
                case 'BLUETOOTH': return 'fab fa-bluetooth-b';
                case 'WIFI': return 'fas fa-wifi';
                default: return 'fas fa-broadcast-tower';
            }
        }

        function renderEarthNetworks() {
            if (!earthNetworksEnabled) return;

            const listEl = document.getElementById('earth-networks-active-list');
            earthNetworksLayerGroup.clearLayers();
            listEl.innerHTML = `<div style="padding: 5px; color: var(--primary-color); border-bottom: 1px solid rgba(0, 255, 209, 0.1);">NETWORKS_DETECTED: ${lastEarthNetworksData.length}</div>`;

            lastEarthNetworksData.forEach(net => {
                const deviceType = getDeviceType(net.ssid || '', net.type);
                const isWifi = net.type === 'wifi';
                const color = isWifi ? 'var(--cyberpunk-cyan)' : 'var(--neon-purple)';
                const iconClass = getDeviceIcon(deviceType);

                const item = document.createElement('div');
                item.className = 'geojson-item';
                item.style.fontSize = '9px';
                item.style.padding = '2px 10px';
                item.style.cursor = 'pointer';
                item.innerHTML = `<span style="color:${color}">[${deviceType}]</span> <i class="${iconClass}"></i> ${net.ssid}`;

                item.onclick = (e) => {
                    e.stopPropagation();
                    map.setView([net.lat, net.lon], 16);
                    L.popup()
                        .setLatLng([net.lat, net.lon])
                        .setContent(`<div style="color:${color}; font-weight:bold;"><i class="${iconClass}"></i> ${net.ssid} (${deviceType})</div>`)
                        .openOn(map);
                };
                listEl.appendChild(item);

                // Map Marker
                const icon = L.divIcon({
                    className: 'custom-cyber-marker',
                    html: `
                        <div class="marker-pulse" style="border-color:${color};"></div>
                        <div class="marker-core" style="background:${color}; display:flex; align-items:center; justify-content:center; color:#000; font-size:8px; width:16px; height:16px; border-radius:50%; margin-top:-2px; margin-left:-2px;">
                            <i class="${iconClass}"></i>
                        </div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                L.marker([net.lat, net.lon], { icon: icon })
                    .bindPopup(`
                        <div style="color:${color}; font-weight:bold; border-bottom:1px solid ${color}; margin-bottom:5px;">
                            <i class="${iconClass}"></i> EARTH_NETWORK_UPLINK
                        </div>
                        <div class="popup-detail-item"><strong>SSID:</strong> ${net.ssid}</div>
                        <div class="popup-detail-item"><strong>TYPE:</strong> ${deviceType}</div>
                        <div class="popup-detail-item"><strong>NETID:</strong> ${net.netid || 'N/A'}</div>
                        <div class="popup-detail-item"><strong>ENCRYPTION:</strong> ${net.encryption || 'N/A'}</div>
                        <div class="popup-detail-item"><strong>COORDS:</strong> ${net.lat.toFixed(4)}, ${net.lon.toFixed(4)}</div>
                    `)
                    .addTo(earthNetworksLayerGroup);
            });
        }

        const onMapClickForEarthNetworks = (e) => {
            if (earthNetworksEnabled) {
                updateEarthNetworks(e.latlng.lat, e.latlng.lng);
            }
        };

        document.getElementById('earth-networks-toggle').addEventListener('change', (e) => {
            earthNetworksEnabled = e.target.checked;
            document.getElementById('earth-networks-active-list').style.display = earthNetworksEnabled ? 'block' : 'none';
            if (earthNetworksEnabled) {
                document.getElementById('earth-networks-active-list').innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px;">CLICK_MAP_TO_SCAN...</div>';
                map.on('click', onMapClickForEarthNetworks);
            } else {
                map.off('click', onMapClickForEarthNetworks);
                earthNetworksLayerGroup.clearLayers();
                document.getElementById('earth-networks-active-list').innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px;">AWAITING_NETWORK_LINK...</div>';
            }
        });

        // --- SEGMENTATION LOGIC ---
        const segmentLayerGroup = L.layerGroup().addTo(map);
        let segmentEnabled = false;

        async function performSegmentation(lat, lon) {
            if (!segmentEnabled) return;

            const listEl = document.getElementById('segments-active-list');
            listEl.innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px; color:#FFFF00;">SCANNING_SECTOR...</div>';

            try {
                const zoom = map.getZoom();
                // Ensure we scan at a high enough resolution
                const scanZoom = Math.max(zoom, 16);

                const res = await axios.get(`/api/geo/segment?lat=${lat}&lon=${lon}&zoom=${scanZoom}`);
                const data = res.data;

                segmentLayerGroup.clearLayers();

                if (data.features && data.features.length > 0) {
                    data.features.forEach(f => {
                        const props = f.properties;
                        const classification = props.classification;
                        const confidence = props.confidence;
                        const bbox = props.bbox; // [[lon1, lat1], [lon2, lat2]]

                        // 1. Draw Polygon Mask
                        const maskLayer = L.geoJSON(f, {
                            style: {
                                color: '#FFFF00',
                                weight: 1,
                                opacity: 0.5,
                                fillColor: '#FFFF00',
                                fillOpacity: 0.05
                            }
                        }).addTo(segmentLayerGroup);

                        // Popup for mask
                        maskLayer.bindPopup(`
                            <div style="color:#FFFF00; font-weight:bold; border-bottom:1px solid #FFFF00; margin-bottom:5px;">
                                REMOTE_AERIAL_OBJECT_CLASSIFICATION: ${classification}
                            </div>
                            <div class="popup-detail-item"><strong>CONF:</strong> ${confidence}</div>
                            <div class="popup-detail-item"><strong>AREA:</strong> ${props.area}</div>
                            <div class="popup-detail-item"><strong>ID:</strong> ${props.id}</div>
                            <div class="popup-detail-item"><strong>V_STATUS:</strong> VALIDATED</div>
                        `);

                        // 2. Draw Bounding Box (Techy look)
                        if (bbox) {
                            const bounds = [[bbox[0][1], bbox[0][0]], [bbox[1][1], bbox[1][0]]];
                            L.rectangle(bounds, {
                                color: '#FFFF00',
                                weight: 1,
                                fill: false,
                                className: 'segment-bbox'
                            }).addTo(segmentLayerGroup);

                            // 3. Add On-Map Label
                            const center = [(bbox[0][1] + bbox[1][1]) / 2, (bbox[0][0] + bbox[1][0]) / 2];
                            const labelIcon = L.divIcon({
                                className: 'segment-label-container',
                                html: `<div class="segment-label">REMOTE_AERIAL_OBJECT_CLASSIFICATION: ${classification} [${confidence}]</div>`,
                                iconSize: [0, 0],
                                iconAnchor: [0, 0]
                            });
                            L.marker(center, { icon: labelIcon, interactive: false }).addTo(segmentLayerGroup);
                        }
                    });

                    listEl.innerHTML = `<div style="padding: 5px; color: #FFFF00; border-bottom: 1px solid rgba(255, 255, 0, 0.1);">OBJECTS_DETECTED: ${data.features.length}</div>`;

                    // Add summary list items
                    data.features.slice(0, 50).forEach(f => {
                        const item = document.createElement('div');
                        item.className = 'geojson-item';
                        item.style.fontSize = '9px';
                        item.style.padding = '2px 10px';
                        item.style.cursor = 'pointer';
                        item.innerHTML = `<span style="color:#FFFF00">[${f.properties.id}]</span> ${f.properties.classification}`;

                        // Zoom to feature
                        item.onclick = (e) => {
                            e.stopPropagation();
                            const bounds = L.geoJSON(f).getBounds();
                            map.fitBounds(bounds, { maxZoom: 19 });
                        };
                        listEl.appendChild(item);
                    });
                }
            } catch (err) {
                console.error("Segmentation Error:", err);
                listEl.innerHTML = `<div class="log-entry alert" style="padding: 5px;">SCAN_ERROR: ${err.message}</div>`;
            }
        }

        const onMapClickForSegmentation = (e) => {
            if (segmentEnabled) {
                performSegmentation(e.latlng.lat, e.latlng.lng);
            }
        };

        document.getElementById('segment-toggle').addEventListener('change', (e) => {
            segmentEnabled = e.target.checked;
            document.getElementById('draw-region-btn').style.display = segmentEnabled ? 'inline-block' : 'none';
            document.getElementById('segments-active-list').style.display = segmentEnabled ? 'block' : 'none';

            if (segmentEnabled) {
                // Switch to Satellite if not already
                if (!document.body.classList.contains('sat-mode')) {
                    // Trigger the layer toggle to switch to satellite
                    // We assume layerToggle logic exists. 
                    const layerToggle = document.getElementById('layer-toggle');
                    // Only click if it says CYBERPUNK (meaning we are in Cyber mode and want to go Sat)
                    // Actually, the toggle text changes. Let's just check the class.
                    if (document.getElementById('map').classList.contains('cyber-mode')) {
                        layerToggle.click();
                    }
                }

                document.getElementById('segments-active-list').innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px;">CLICK_MAP_TO_SCAN...</div>';
                map.on('click', onMapClickForSegmentation);

                // Also scan the center immediately
                const center = map.getCenter();
                performSegmentation(center.lat, center.lng);

            } else {
                map.off('click', onMapClickForSegmentation);
                segmentLayerGroup.clearLayers();
                document.getElementById('segments-active-list').innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px;">AWAITING_SAT_ANALYSIS...</div>';
            }
        });

        // --- RECTANGLE DRAWING LOGIC FOR SEGMENTATION ---
        let drawControl = null;
        let drawnRectangle = null;
        let drawingEnabled = false;

        document.getElementById('draw-region-btn').addEventListener('click', () => {
            if (!drawingEnabled) {
                // Enable drawing mode
                drawingEnabled = true;
                document.getElementById('draw-region-btn').innerHTML = '<i class="fas fa-times"></i> CANCEL';
                document.getElementById('draw-region-btn').style.background = 'rgba(255, 0, 0, 0.3)';

                // Clear previous rectangle
                if (drawnRectangle) {
                    map.removeLayer(drawnRectangle);
                    drawnRectangle = null;
                }

                // Create draw control for rectangle only
                if (!drawControl) {
                    const drawnItems = new L.FeatureGroup();
                    map.addLayer(drawnItems);

                    drawControl = new L.Control.Draw({
                        draw: {
                            rectangle: {
                                shapeOptions: {
                                    color: '#FFFF00',
                                    weight: 2,
                                    opacity: 0.8,
                                    fillOpacity: 0.1
                                }
                            },
                            polygon: false,
                            polyline: false,
                            circle: false,
                            marker: false,
                            circlemarker: false
                        },
                        edit: {
                            featureGroup: drawnItems,
                            remove: false
                        }
                    });

                    map.addControl(drawControl);

                    map.on(L.Draw.Event.CREATED, async (e) => {
                        const layer = e.layer;
                        drawnRectangle = layer;
                        map.addLayer(layer);

                        // Get bounds of rectangle
                        const bounds = layer.getBounds();
                        const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;

                        // Disable drawing mode
                        drawingEnabled = false;
                        document.getElementById('draw-region-btn').innerHTML = '<i class="fas fa-draw-polygon"></i> DRAW REGION';
                        document.getElementById('draw-region-btn').style.background = 'rgba(255, 255, 0, 0.2)';

                        // Perform segmentation on this region
                        const listEl = document.getElementById('segments-active-list');
                        listEl.innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px; color:#FFFF00;">SCANNING_REGION...</div>';

                        try {
                            const center = bounds.getCenter();
                            const zoom = map.getZoom();
                            const scanZoom = Math.max(zoom, 17);

                            const res = await axios.get(`/api/geo/segment?lat=${center.lat}&lon=${center.lng}&zoom=${scanZoom}&bbox=${bbox}`);
                            const data = res.data;

                            segmentLayerGroup.clearLayers();

                            if (data.features && data.features.length > 0) {
                                data.features.forEach(f => {
                                    const props = f.properties;
                                    const classification = props.classification;
                                    const confidence = props.confidence;
                                    const bbox = props.bbox;

                                    // 1. Draw Polygon Mask
                                    const maskLayer = L.geoJSON(f, {
                                        style: {
                                            color: '#FFFF00',
                                            weight: 1,
                                            opacity: 0.5,
                                            fillColor: '#FFFF00',
                                            fillOpacity: 0.05
                                        }
                                    }).addTo(segmentLayerGroup);

                                    maskLayer.bindPopup(`
                                        <div style="color:#FFFF00; font-weight:bold; border-bottom:1px solid #FFFF00; margin-bottom:5px;">
                                            REMOTE_AERIAL_OBJECT_CLASSIFICATION: ${classification}
                                        </div>
                                        <div class="popup-detail-item"><strong>CONF:</strong> ${confidence}</div>
                                        <div class="popup-detail-item"><strong>AREA:</strong> ${props.area}</div>
                                        <div class="popup-detail-item"><strong>ID:</strong> ${props.id}</div>
                                        <div class="popup-detail-item"><strong>V_STATUS:</strong> VALIDATED</div>
                                    `);

                                    // 2. Draw Bounding Box
                                    if (bbox) {
                                        const bounds = [[bbox[0][1], bbox[0][0]], [bbox[1][1], bbox[1][0]]];
                                        L.rectangle(bounds, {
                                            color: '#FFFF00',
                                            weight: 1,
                                            fill: false,
                                            className: 'segment-bbox'
                                        }).addTo(segmentLayerGroup);

                                        // 3. Add On-Map Label
                                        const center = [(bbox[0][1] + bbox[1][1]) / 2, (bbox[0][0] + bbox[1][0]) / 2];
                                        const labelIcon = L.divIcon({
                                            className: 'segment-label-container',
                                            html: `<div class="segment-label">REMOTE_AERIAL_OBJECT_CLASSIFICATION: ${classification} [${confidence}]</div>`,
                                            iconSize: [0, 0],
                                            iconAnchor: [0, 0]
                                        });
                                        L.marker(center, { icon: labelIcon, interactive: false }).addTo(segmentLayerGroup);
                                    }
                                });

                                listEl.innerHTML = `<div style="padding: 5px; color: #FFFF00; border-bottom: 1px solid rgba(255, 255, 0, 0.1);">OBJECTS_DETECTED: ${data.features.length}</div>`;

                                data.features.slice(0, 50).forEach(f => {
                                    const item = document.createElement('div');
                                    item.className = 'geojson-item';
                                    item.style.fontSize = '9px';
                                    item.style.padding = '2px 10px';
                                    item.style.cursor = 'pointer';
                                    item.innerHTML = `<span style="color:#FFFF00">[${f.properties.id}]</span> ${f.properties.classification}`;

                                    item.onclick = (e) => {
                                        e.stopPropagation();
                                        const bounds = L.geoJSON(f).getBounds();
                                        map.fitBounds(bounds, { maxZoom: 19 });
                                    };
                                    listEl.appendChild(item);
                                });
                            }
                        } catch (err) {
                            console.error("Segmentation Error:", err);
                            listEl.innerHTML = `<div class="log-entry alert" style="padding: 5px;">SCAN_ERROR: ${err.message}</div>`;
                        }
                    });
                }

                // Trigger rectangle drawing
                new L.Draw.Rectangle(map, drawControl.options.draw.rectangle).enable();

            } else {
                // Cancel drawing mode
                drawingEnabled = false;
                document.getElementById('draw-region-btn').innerHTML = '<i class="fas fa-draw-polygon"></i> DRAW REGION';
                document.getElementById('draw-region-btn').style.background = 'rgba(255, 255, 0, 0.2)';
            }
        });


        document.querySelectorAll('.geojson-checkbox').forEach(cb => {
            cb.addEventListener('change', async (e) => {
                const filename = e.target.getAttribute('data-filename');

                if (e.target.checked) {
                    document.querySelectorAll('.geojson-checkbox').forEach(c => { if (c !== e.target) c.checked = false; });
                    try {
                        const res = await axios.get(`/api/geojson/${filename}`);
                        renderGeoJSONOnMap(res.data);
                    } catch (err) { console.error("GeoJSON load error:", err); }
                } else {
                    geojsonLayerGroup.clearLayers();
                }
            });
        });



        // --- USER-SPECIFIED IMAGE UPLINK LOGIC ---
        const userForm = document.getElementById('user-uplink-form');
        if (userForm) {
            userForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('img');
                const file = fileInput.files[0];
                if (!file) return;

                // Create a temporary status entry in the list
                const listEl = document.getElementById('segments-active-list');
                if (listEl) {
                    listEl.style.display = 'block';
                    listEl.innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px; color:#00FFD1;">UPLOADING_IMAGE... ANALYZING_VECTORS...</div>';
                }

                const formData = new FormData();
                formData.append('img', file); // Matching user's name="img"

                try {
                    // Use the user's action path but handle it via AJAX for the popup result
                    const res = await axios.post('/upload', formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });
                    const data = res.data;

                    if (data.status === "ANALYSIS_COMPLETE") {
                        if (listEl) listEl.innerHTML = `<div class="log-entry success" style="padding: 5px; color: #00FFD1;">DISCOVERY_COMPLETE: ${data.count} OBJ FOUND</div>`;

                        // Show Modal
                        const modal = document.getElementById('discovery-modal');
                        if (modal) {
                            modal.style.display = 'block';
                            document.getElementById('discovery-time').innerText = data.timestamp;

                            const loc = data.location;
                            if (loc && loc.lat !== "UNKNOWN") {
                                document.getElementById('discovery-loc').innerText = `${loc.lat.toFixed(6)}, ${loc.lon.toFixed(6)}`;
                                map.setView([loc.lat, loc.lon], 16);
                            } else {
                                document.getElementById('discovery-loc').innerText = "DATA_REDACTED / NO_GPS";
                            }

                            // Preview Image
                            const reader = new FileReader();
                            reader.onload = (ev) => {
                                document.getElementById('discovery-img').src = ev.target.result;
                            };
                            reader.readAsDataURL(file);

                            // Render Object List
                            const listContainer = document.getElementById('discovery-list');
                            if (listContainer) {
                                listContainer.innerHTML = '';
                                data.objects.forEach(obj => {
                                    const item = document.createElement('div');
                                    item.style.padding = '4px 0';
                                    item.style.borderBottom = '1px solid rgba(0, 255, 209, 0.1)';
                                    item.innerHTML = `<span style="color:#00FFD1; font-weight:bold;">[${obj.tag}]</span> ${obj.object} (${obj.confidence})`;
                                    listContainer.appendChild(item);
                                });
                            }
                        }
                    }
                } catch (err) {
                    console.error("Discovery Error:", err);
                    if (listEl) listEl.innerHTML = `<div class="log-entry alert" style="padding: 5px;">UPLINK_FAILED: ${err.message}</div>`;
                }
            });
        }


        // Map button just triggers the hidden input dialog in the form
        if (document.getElementById('map-uplink-btn')) {
            document.getElementById('map-uplink-btn').addEventListener('click', () => {
                document.getElementById('image-uplink-input').click();
            });
        }

        // Form submission handler
        document.getElementById('image-uplink-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('image-uplink-input');
            const file = fileInput.files[0];
            if (!file) {
                alert("NO_SOURCE_IMAGE_DETECTED");
                return;
            }

            // Show loading state
            const listEl = document.getElementById('segments-active-list');
            listEl.style.display = 'block';
            listEl.innerHTML = '<div class="log-entry info" style="padding: 5px; font-size: 10px; color:#00FFD1;">UPLOADING_IMAGE... ANALYZING_VECTORS...</div>';

            const formData = new FormData();
            formData.append('image', file);

            try {
                const res = await axios.post('/api/geo/analyze-upload', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                const data = res.data;

                if (data.status === "ANALYSIS_COMPLETE") {
                    listEl.innerHTML = `<div class="log-entry success" style="padding: 5px; color: #00FFD1;">DISCOVERY_COMPLETE: ${data.count} OBJ FOUND</div>`;

                    // Show Modal
                    const modal = document.getElementById('discovery-modal');
                    modal.style.display = 'block';
                    document.getElementById('discovery-time').innerText = data.timestamp;

                    const loc = data.location;
                    if (loc && loc.lat !== "UNKNOWN") {
                        document.getElementById('discovery-loc').innerText = `${loc.lat.toFixed(6)}, ${loc.lon.toFixed(6)}`;
                        map.setView([loc.lat, loc.lon], 16);

                        // Clear old markers if any
                        if (window.discoveryMarker) map.removeLayer(window.discoveryMarker);

                        window.discoveryMarker = L.marker([loc.lat, loc.lon], {
                            icon: L.divIcon({
                                className: 'discovery-marker',
                                html: '<div style="width:20px; height:20px; border:2px solid #00FFD1; border-radius:50%; box-shadow: 0 0 10px #00FFD1; position:relative;"><div style="width:6px; height:6px; background:#00FFD1; border-radius:50%; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);"></div></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map).bindPopup(`<strong>DISCOVERY_ORIGIN</strong><br>${loc.lat.toFixed(6)}, ${loc.lon.toFixed(6)}`).openPopup();
                    } else {
                        document.getElementById('discovery-loc').innerText = "DATA_REDACTED / NO_GPS";
                    }

                    // Preview Image
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        document.getElementById('discovery-img').src = ev.target.result;
                    };
                    reader.readAsDataURL(file);

                    // Render Object List
                    const listContainer = document.getElementById('discovery-list');
                    listContainer.innerHTML = '';
                    if (data.objects && data.objects.length > 0) {
                        data.objects.forEach(obj => {
                            const item = document.createElement('div');
                            item.style.padding = '4px 0';
                            item.style.borderBottom = '1px solid rgba(0, 255, 209, 0.1)';
                            item.innerHTML = `<span style="color:#00FFD1; font-weight:bold;">[${obj.tag}]</span> ${obj.object} (${obj.confidence})`;
                            listContainer.appendChild(item);
                        });
                    } else {
                        listContainer.innerHTML = '<div style="color:rgba(0, 255, 209, 0.5); padding: 10px; text-align: center;">NO_ENTITY_DETECTED_IN_SECTOR</div>';
                    }
                }
            } catch (err) {
                console.error("Discovery Error:", err);
                listEl.innerHTML = `<div class="log-entry alert" style="padding: 5px;">UPLINK_FAILED: ${err.message}</div>`;
            }

            // Note: Not resetting file input automatically so user can re-submit if needed, 
            // but generally good to reset after success.
        });
    </script>

    <!-- Discovery Analysis Result Modal -->
    <div id="discovery-modal"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; background: rgba(0, 10, 10, 0.95); border: 1px solid #00FFD1; box-shadow: 0 0 20px rgba(0, 255, 209, 0.4); z-index: 9999; padding: 0; font-family: 'Courier New', Courier, monospace; color: #00FFD1;">
        <div
            style="background: rgba(0, 255, 209, 0.2); padding: 5px 10px; border-bottom: 1px solid #00FFD1; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: bold; font-size: 12px; letter-spacing: 2px;">DISCOVERY_ANALYSIS_REPORT</span>
            <button onclick="document.getElementById('discovery-modal').style.display='none'"
                style="background:transparent; border:none; color:#00FFD1; cursor:pointer;"><i
                    class="fas fa-times"></i></button>
        </div>
        <div style="padding: 15px;">
            <div id="discovery-preview"
                style="width: 100%; height: 200px; background: #000; border: 1px solid rgba(0, 255, 209, 0.3); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                <img id="discovery-img" src="" style="max-width: 100%; max-height: 100%;">
            </div>
            <div id="discovery-meta"
                style="font-size: 10px; margin-bottom: 15px; border-bottom: 1px solid rgba(0, 255, 209, 0.1); padding-bottom: 10px;">
                <div class="popup-detail-item"><strong>LOC_COORDS:</strong> <span id="discovery-loc">PENDING...</span>
                </div>
                <div class="popup-detail-item"><strong>TIMESTAMP:</strong> <span id="discovery-time">---</span></div>
            </div>
            <div id="discovery-objects" style="max-height: 150px; overflow-y: auto; font-size: 9px;">
                <div
                    style="border-bottom: 1px solid rgba(0, 255, 209, 0.2); padding-bottom: 5px; margin-bottom: 5px; font-weight: bold;">
                    OBJECTS_IDENTIFIED:</div>
                <div id="discovery-list"></div>
            </div>
        </div>
        <div
            style="padding: 10px 15px; background: rgba(0, 255, 209, 0.05); display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(0, 255, 209, 0.2);">
            <div style="font-size: 8px; color: rgba(0, 255, 209, 0.5);">SECURE_LINK_ENCRYPTED // v1.2</div>
            <button onclick="document.getElementById('discovery-modal').style.display='none'"
                style="background: rgba(0, 255, 209, 0.2); border: 1px solid #00FFD1; color: #00FFD1; padding: 2px 10px; cursor: pointer; font-size: 9px; font-weight: bold; text-transform: uppercase;">Close
                Report</button>
        </div>
    </div>

    <!-- GeoSential AI Chat Fabric Button -->
    <button id="geosentialai-fab" title="GeoSential AI Assistant"
        style="position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #00FFD1 0%, #0099FF 100%); border: 2px solid #00FFD1; color: #000; font-size: 24px; cursor: pointer; box-shadow: 0 0 20px rgba(0, 255, 209, 0.6), 0 0 40px rgba(0, 153, 255, 0.3); z-index: 9998; font-weight: bold; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-brain"></i>
    </button>

    <!-- GeoSential AI Chat Modal -->
    <div id="geosentialai-modal"
        style="display: none; position: fixed; bottom: 100px; right: 20px; width: 420px; height: 600px; background: rgba(0, 0, 0, 0.98); border: 2px solid #00FFD1; border-radius: 12px; box-shadow: 0 0 30px rgba(0, 255, 209, 0.5), inset 0 0 20px rgba(0, 255, 209, 0.1); z-index: 9999; font-family: 'Courier New', monospace; flex-direction: column; color: #00FFD1;">

        <!-- Header -->
        <div
            style="background: rgba(0, 255, 209, 0.1); border-bottom: 1px solid #00FFD1; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-radius: 10px 10px 0 0;">
            <div style="font-weight: bold; letter-spacing: 2px; font-size: 12px;">GEOSENTIAL AI v1.0</div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <span id="ollama-status" style="font-size: 10px; color: #FF6B00;">⚠ CONNECTING</span>
                <div style="display: flex; gap: 8px;">
                    <button id="geosentialai-minimize" title="Minimize"
                        style="background: transparent; border: none; color: #00FFD1; cursor: pointer; font-size: 16px; padding: 0;">—</button>
                    <button id="geosentialai-close" title="Close"
                        style="background: transparent; border: none; color: #00FFD1; cursor: pointer; font-size: 16px; padding: 0;">✕</button>
                </div>
            </div>
        </div>

        <!-- Toggles Section -->
        <div id="geosentialai-controls"
            style="padding: 10px 12px; border-bottom: 1px solid rgba(0, 255, 209, 0.2); display: flex; gap: 12px; flex-wrap: wrap; background: rgba(0, 255, 209, 0.02); align-items: center;">
            <label style="font-size: 10px; display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="web-search-toggle" style="cursor: pointer;">
                <span>WEB</span>
            </label>
            <label style="font-size: 10px; display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="tts-toggle" style="cursor: pointer;">
                <span>TTS</span>
            </label>
            <label style="font-size: 10px; display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="context-toggle" checked style="cursor: pointer;">
                <span>CONTEXT</span>
            </label>
            <label style="font-size: 10px; display: flex; align-items: center; gap: 6px; cursor: pointer;"
                title="Toggle Human-like personality">
                <input type="checkbox" id="human-mode-toggle" style="cursor: pointer;">
                <span>HUMAN</span>
            </label>

            <div style="margin-left: auto; display: flex; align-items: center; gap: 4px;">
                <span style="font-size: 8px; color: rgba(0, 255, 209, 0.6);">ENGINE:</span>
                <select id="ai-engine-select"
                    style="background: rgba(0, 15, 30, 0.9); border: 1px solid rgba(0, 255, 209, 0.5); color: #00FFD1; font-size: 9px; padding: 2px; border-radius: 3px; font-family: 'Courier New'; outline: none; cursor: pointer;">
                    <option value="huggingface" selected>CLOUD (HF)</option>
                    <option value="ollama">LOCAL (OLLAMA)</option>
                </select>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="geosentialai-messages"
            style="flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; background: rgba(0, 0, 0, 0.3);">
            <div style="font-size: 9px; color: rgba(0, 255, 209, 0.5); text-align: center; padding: 10px 0;">
                INITIALIZING_NEURAL_LINK...
            </div>
        </div>

        <!-- Input Section -->
        <div
            style="border-top: 1px solid rgba(0, 255, 209, 0.2); padding: 12px; background: rgba(0, 255, 209, 0.02); display: flex; gap: 8px;">
            <button id="memory-bank-btn" title="Neural Memory Bank"
                style="background: rgba(0, 0, 0, 0.6); border: 1px solid #00FFD1; color: #00FFD1; padding: 8px; border-radius: 4px; cursor: pointer; transition: 0.2s;">
                <i class="fas fa-database"></i>
            </button>
            <input type="text" id="geosentialai-input" placeholder="Enter query..."
                style="flex: 1; background: rgba(0, 255, 209, 0.05); border: 1px solid #00FFD1; color: #00FFD1; padding: 8px 10px; border-radius: 4px; font-family: 'Courier New'; font-size: 11px; outline: none;" />
            <button id="geosentialai-send"
                style="background: rgba(0, 255, 209, 0.2); border: 1px solid #00FFD1; color: #00FFD1; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; transition: all 0.2s;">
                SEND
            </button>
        </div>

        <!-- Audio Player -->
        <audio id="geosentialai-audio" style="display: none;"></audio>
    </div>

    <!-- Memory Management Modal -->
    <div id="memory-modal"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 800px; max-width: 90%; height: 600px; background: rgba(5, 10, 15, 0.95); border: 1px solid #00FFD1; box-shadow: 0 0 50px rgba(0, 255, 209, 0.2); z-index: 10000; flex-direction: column; backdrop-filter: blur(10px);">
        <div
            style="padding: 15px; border-bottom: 1px solid rgba(0, 255, 209, 0.3); display: flex; justify-content: space-between; align-items: center; background: rgba(0, 255, 209, 0.05);">
            <div style="font-family: 'Orbitron', sans-serif; color: #00FFD1; letter-spacing: 2px; font-size: 14px;">
                NEURAL MEMORY BANK (CHROMADB)</div>
            <div style="display:flex; gap:15px; align-items:center;">
                <button onclick="clearAllMemories()"
                    style="background: rgba(255, 0, 85, 0.1); border: 1px solid #FF0055; color: #FF0055; font-size: 10px; padding: 4px 10px; cursor: pointer; text-transform: uppercase; font-weight: bold;">CLEAR
                    ALL</button>
                <div id="memory-close" style="cursor: pointer; color: #00FFD1; font-size: 20px;">&times;</div>
            </div>
        </div>
        <div id="memory-list"
            style="flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;">
            <div style="text-align: center; color: rgba(0, 255, 209, 0.5); margin-top: 50px;">LOADING_VECTORS...</div>
        </div>
    </div>

    <!-- Omni-Search Results Application -->
    <div id="omni-search-modal"
        style="display: none; position: fixed; top: 10%; right: 2%; width: 400px; max-height: 80vh; background: rgba(5, 10, 15, 0.95); border: 1px solid #00FFD1; box-shadow: 0 0 30px rgba(0, 255, 209, 0.15); z-index: 5001; flex-direction: column; backdrop-filter: blur(12px); border-radius: 8px;">
        <div
            style="padding: 10px 15px; border-bottom: 1px solid rgba(0, 255, 209, 0.2); display: flex; justify-content: space-between; align-items: center; background: rgba(0, 255, 209, 0.05);">
            <div style="font-family: 'Orbitron', sans-serif; color: #00FFD1; letter-spacing: 1px; font-size: 12px;">
                OMNI-SEARCH RESULTS</div>
            <div style="display:flex; gap:10px;">
                <div id="omni-minimize" style="cursor: pointer; color: #00FFD1;">—</div>
                <div id="omni-close" style="cursor: pointer; color: #00FFD1;">&times;</div>
            </div>
        </div>
        <div id="omni-results-list"
            style="flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; font-size: 12px; color: #ccc;">
            <!-- Results injected here -->
        </div>
        <div style="padding: 10px; border-top: 1px solid rgba(0, 255, 209, 0.2); text-align: center;">
            <button id="omni-share-ai"
                style="background: rgba(0, 255, 209, 0.1); width: 100%; border: 1px solid #00FFD1; color: #00FFD1; padding: 6px; font-size: 11px; cursor: pointer; letter-spacing: 1px;">
                <i class="fas fa-brain"></i> INJECT TO NEURAL CORE
            </button>
        </div>
    </div>

    <script>
        // GeoSential AI Chat Implementation
        const fabBtn = document.getElementById('geosentialai-fab');
        const modal = document.getElementById('geosentialai-modal');
        const minimizeBtn = document.getElementById('geosentialai-minimize');
        const closeBtn = document.getElementById('geosentialai-close');
        const sendBtn = document.getElementById('geosentialai-send');
        const inputField = document.getElementById('geosentialai-input');
        const messagesDiv = document.getElementById('geosentialai-messages');
        const webSearchToggle = document.getElementById('web-search-toggle');
        const ttsToggle = document.getElementById('tts-toggle');
        const contextToggle = document.getElementById('context-toggle');
        const humanModeToggle = document.getElementById('human-mode-toggle');
        const statusSpan = document.getElementById('ollama-status');
        const audioPlayer = document.getElementById('geosentialai-audio');
        const controlsDiv = document.getElementById('geosentialai-controls');
        const engineSelect = document.getElementById('ai-engine-select');
        let isMinimized = false;

        // Toggle Minimize
        minimizeBtn.addEventListener('click', () => {
            isMinimized = !isMinimized;
            if (isMinimized) {
                messagesDiv.style.display = 'none';
                controlsDiv.style.display = 'none';
                inputField.parentElement.style.display = 'none';
                modal.style.height = 'auto';
                minimizeBtn.textContent = '▢';
            } else {
                messagesDiv.style.display = 'flex';
                controlsDiv.style.display = 'flex';
                inputField.parentElement.style.display = 'flex';
                modal.style.height = '600px';
                minimizeBtn.textContent = '—';
            }
        });

        // FAB Button Interaction
        fabBtn.addEventListener('click', () => {
            if (modal.style.display === 'none') {
                modal.style.display = 'flex';
                inputField.focus();
                checkOllamaStatus();
            } else {
                modal.style.display = 'none';
            }
        });

        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // FAB Hover Effect
        fabBtn.addEventListener('mouseenter', () => {
            fabBtn.style.transform = 'scale(1.1)';
            fabBtn.style.boxShadow = '0 0 30px rgba(0, 255, 209, 0.8), 0 0 60px rgba(0, 153, 255, 0.5)';
        });

        fabBtn.addEventListener('mouseleave', () => {
            fabBtn.style.transform = 'scale(1)';
            fabBtn.style.boxShadow = '0 0 20px rgba(0, 255, 209, 0.6), 0 0 40px rgba(0, 153, 255, 0.3)';
        });

        // Check Ollama Status
        async function checkOllamaStatus() {
            try {
                const res = await fetch('/api/geosentialai/status');
                const data = await res.json();
                if (data.status === 'CONNECTED') {
                    statusSpan.textContent = '● ONLINE';
                    statusSpan.style.color = '#00FF00';
                } else {
                    statusSpan.textContent = '● OFFLINE';
                    statusSpan.style.color = '#FF6B00';
                }
            } catch (e) {
                statusSpan.textContent = '● ERROR';
                statusSpan.style.color = '#FF0000';
            }
        }

        // Gather Map Context Data
        function getMapContext() {
            let context = {
                flights: [],
                vessels: [],
                cells: [],
                networks: [],
                surveillance: [],
                sentiment: ""
            };

            // Collect flight data
            if (typeof flightMarkers !== 'undefined') {
                context.flights = Object.keys(flightMarkers).slice(0, 5).map(icao => {
                    const m = flightMarkers[icao];
                    return { icao, lat: m.getLatLng().lat, lng: m.getLatLng().lng };
                });
            }

            // Collect vessel data
            if (typeof vesselMarkers !== 'undefined') {
                context.vessels = Object.keys(vesselMarkers).slice(0, 5).map(mmsi => {
                    const m = vesselMarkers[mmsi];
                    return { mmsi, lat: m.getLatLng().lat, lng: m.getLatLng().lng };
                });
            }

            // Collect additional layer data from log lists
            const towerList = document.getElementById('towers-active-list');
            if (towerList && towerList.style.display !== 'none') {
                context.cells = Array.from(towerList.querySelectorAll('.log-entry')).slice(0, 5).map(el => el.textContent.trim());
            }

            const netList = document.getElementById('earth-networks-active-list');
            if (netList && netList.style.display !== 'none') {
                context.networks = Array.from(netList.querySelectorAll('.log-entry')).slice(0, 5).map(el => el.textContent.trim());
            }

            const satList = document.getElementById('segments-active-list');
            if (satList && satList.style.display !== 'none') {
                context.surveillance = Array.from(satList.querySelectorAll('.log-entry')).slice(0, 5).map(el => el.textContent.trim());
            }

            const sentList = document.getElementById('sentiment-active-list');
            if (sentList && sentList.style.display !== 'none') {
                const firstEntry = sentList.querySelector('.log-entry');
                if (firstEntry) context.sentiment = firstEntry.textContent.trim();
            }

            return context;
        }



        // Add Message to Chat
        function addMessage(text, sender = 'ai') {
            const msgDiv = document.createElement('div');

            if (sender === 'user') {
                msgDiv.className = 'user-msg';
                msgDiv.textContent = '> ' + text;
            } else if (sender === 'system') {
                msgDiv.className = 'system-msg';
                msgDiv.textContent = text;
            } else {
                msgDiv.className = 'ai-msg';
                // Render markdown using marked
                msgDiv.innerHTML = typeof marked !== 'undefined' ? marked.parse(text) : text;

                // Ensure all links in AI messages open in new tab
                msgDiv.querySelectorAll('a').forEach(a => a.target = '_blank');
            }

            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Send Message to AI
        async function sendMessage() {
            const userMessage = inputField.value.trim();
            if (!userMessage) return;

            addMessage(userMessage, 'user');
            inputField.value = '';
            sendBtn.disabled = true;
            sendBtn.textContent = 'PROCESSING...';

            try {
                const payload = {
                    message: userMessage,
                    web_search: webSearchToggle.checked,
                    engine: engineSelect.value,
                    human_mode: humanModeToggle.checked,
                    context: contextToggle.checked ? getMapContext() : {}
                };

                const response = await fetch('/api/geosentialai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const data = await response.json();
                    const reply = data.reply || data.response;
                    addMessage(reply, 'ai');

                    // Parse commands: [TRACK_FLIGHT: ICAO]
                    const flightMatch = reply.match(/\[TRACK_FLIGHT:\s*(\w+)\]/i);
                    if (flightMatch) {
                        const icao = flightMatch[1].toLowerCase();
                        addMessage(`COMMAND_DETECTED: TRACKING_FLIGHT_${icao.toUpperCase()}`, 'system');
                        if (typeof flightMarkers !== 'undefined' && flightMarkers[icao]) {
                            map.setView(flightMarkers[icao].getLatLng(), 10);
                            flightMarkers[icao].openPopup();
                        }
                    }

                    // Parse commands: [TRACK_VESSEL: MMSI]
                    const vesselMatch = reply.match(/\[TRACK_VESSEL:\s*(\d+)\]/i);
                    if (vesselMatch) {
                        const mmsi = vesselMatch[1];
                        addMessage(`COMMAND_DETECTED: TRACKING_VESSEL_${mmsi}`, 'system');
                        if (typeof vesselMarkers !== 'undefined' && vesselMarkers[mmsi]) {
                            map.setView(vesselMarkers[mmsi].getLatLng(), 10);
                            vesselMarkers[mmsi].openPopup();
                        }
                    }

                    // Parse commands: [SHOW_WEATHER: lat, lng]
                    const weatherMatch = reply.match(/\[SHOW_WEATHER:\s*([\-\d\.]+),\s*([\-\d\.]+)\]/i);
                    if (weatherMatch) {
                        const lat = parseFloat(weatherMatch[1]);
                        const lng = parseFloat(weatherMatch[2]);
                        addMessage(`COMMAND_DETECTED: PULLING_METEOROLOGICAL_DATA`, 'system');
                        if (typeof showLocationInfo === 'function') {
                            showLocationInfo(lat, lng);
                        }
                    }

                    // Parse commands: [SCAN_MAP: lat, lng]
                    const scanMatch = reply.match(/\[SCAN_MAP:\s*([\-\d\.]+),\s*([\-\d\.]+)\]/i);
                    if (scanMatch) {
                        const lat = parseFloat(scanMatch[1]);
                        const lng = parseFloat(scanMatch[2]);
                        addMessage(`COMMAND_DETECTED: SECTOR_SCAN_INITIATED`, 'system');
                        map.setView([lat, lng], 13);

                        // Visual Pulse Effect
                        const pulse = L.divIcon({
                            className: 'scan-pulse-div',
                            iconSize: [0, 0],
                            iconAnchor: [0, 0]
                        });
                        const pulseMarker = L.marker([lat, lng], { icon: pulse, interactive: false }).addTo(map);
                        setTimeout(() => map.removeLayer(pulseMarker), 2500);

                        // Trigger specific scan logic if available
                        if (typeof analyzeUploadedImage === 'function') {
                            // Placeholder for bot scan
                        }
                    }

                    // TTS via gTTS (Backend)
                    if (ttsToggle.checked && data.audio) {
                        try {
                            const binary = atob(data.audio);
                            const array = new Uint8Array(binary.length);
                            for (let i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);
                            const blob = new Blob([array], { type: 'audio/mpeg' });
                            const url = URL.createObjectURL(blob);
                            audioPlayer.src = url;
                            audioPlayer.play();
                        } catch (audioErr) {
                            console.error("TTS Audio Error:", audioErr);
                        }
                    }
                } else {
                    const error = await response.json();
                    addMessage(`ERROR: ${error.reply || error.error || 'Unknown error'}`, 'system');
                }
            } catch (e) {
                addMessage(`CONNECTION ERROR: ${e.message}`, 'system');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'SEND';
                inputField.focus();
            }
        }

        // --- Memory Bank Logic ---
        const memoryBtn = document.getElementById('memory-bank-btn');
        const memoryModal = document.getElementById('memory-modal');
        const memoryClose = document.getElementById('memory-close');
        const memoryList = document.getElementById('memory-list');

        if (memoryBtn) {
            memoryBtn.addEventListener('click', () => {
                memoryModal.style.display = 'flex';
                loadMemories();
            });
        }

        if (memoryClose) {
            memoryClose.addEventListener('click', () => {
                memoryModal.style.display = 'none';
            });
        }

        async function loadMemories() {
            memoryList.innerHTML = '<div style="text-align: center; color: rgba(0, 255, 209, 0.5); margin-top: 50px;">ACCESSING_NEURAL_ARCHIVE...</div>';
            try {
                const res = await fetch('/api/geosentialai/memory');
                const data = await res.json();

                if (data.memories && data.memories.length > 0) {
                    memoryList.innerHTML = '';
                    data.memories.forEach(mem => {
                        const item = document.createElement('div');
                        item.style.cssText = "background: rgba(0, 255, 209, 0.05); padding: 10px; border: 1px solid rgba(0, 255, 209, 0.1); display: flex; flex-direction: column; gap: 5px;";

                        // Parse content for display
                        const content = mem.content.replace(/\n/g, '<br>');

                        item.innerHTML = `
                            <div style="font-size: 10px; color: rgba(0, 255, 209, 0.5); display: flex; justify-content: space-between;">
                                <span>ID: ${mem.id}</span>
                                <span>${new Date(mem.timestamp).toLocaleString()}</span>
                            </div>
                            <div style="font-size: 12px; color: #fff; line-height: 1.4; max-height: 100px; overflow-y: auto;">
                                ${content}
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 5px; justify-content: flex-end;">
                                <button onclick="editMemory('${mem.id}')" style="background: none; border: 1px solid #00FFD1; color: #00FFD1; font-size: 10px; padding: 2px 8px; cursor: pointer;">EDIT</button>
                                <button onclick="deleteMemory('${mem.id}')" style="background: none; border: 1px solid #FF0055; color: #FF0055; font-size: 10px; padding: 2px 8px; cursor: pointer;">DELETE</button>
                            </div>
                        `;
                        memoryList.appendChild(item);
                    });
                } else {
                    memoryList.innerHTML = '<div style="text-align: center; color: rgba(0, 255, 209, 0.5); margin-top: 50px;">ARCHIVE_EMPTY</div>';
                }
            } catch (e) {
                memoryList.innerHTML = `<div style="text-align: center; color: #FF0055; margin-top: 50px;">CONNECTION_ERROR: ${e.message}</div>`;
            }
        }

        window.deleteMemory = async (id) => {
            if (!confirm('DELETE_MEMORY_VECTOR? This cannot be undone.')) return;
            try {
                await fetch(`/api/geosentialai/memory/${id}`, { method: 'DELETE' });
                loadMemories(); // Refresh
            } catch (e) {
                alert('Deletion failed: ' + e.message);
            }
        };

        window.clearAllMemories = async () => {
            if (!confirm('WARNING: PURGE ALL NEURAL MEMORY? This action is irreversible.')) return;
            try {
                await fetch('/api/geosentialai/memory/all', { method: 'DELETE' });
                loadMemories();
            } catch (e) {
                alert('Purge failed: ' + e.message);
            }
        };

        window.editMemory = async (id) => {
            const newContent = prompt("EDIT_MEMORY_VECTOR:");
            if (newContent) {
                try {
                    await fetch(`/api/geosentialai/memory/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: newContent })
                    });
                    loadMemories(); // Refresh
                } catch (e) {
                    alert('Update failed: ' + e.message);
                }
            }
        };

        // --- Omni-Search Logic ---
        const scrapeBtn = document.getElementById('scrape-btn');
        const scrapeQuery = document.getElementById('scrape-query');
        const scrapeType = document.getElementById('scrape-type');

        const scrapeAggressive = document.getElementById('scrape-aggressive');

        const omniModal = document.getElementById('omni-search-modal');
        const omniList = document.getElementById('omni-results-list');
        const omniClose = document.getElementById('omni-close');
        const omniMinimize = document.getElementById('omni-minimize');
        const omniShare = document.getElementById('omni-share-ai');

        let isOmniMinimized = false;
        let lastScrapeResults = [];

        if (scrapeBtn) {
            scrapeBtn.addEventListener('click', async () => {
                const query = scrapeQuery.value.trim();
                if (!query) return;

                scrapeBtn.textContent = 'SCANNING...';
                scrapeBtn.disabled = true;
                omniModal.style.display = 'flex';
                omniList.innerHTML = '<div style="text-align: center; margin-top: 20px;">INITIATING_VECTOR_SEARCH...</div>';

                try {
                    const res = await fetch('/api/tools/web_scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: query,
                            query: query,
                            type: scrapeType.value,
                            sources: Array.from(document.querySelectorAll('.scrape-source-cb:checked')).map(cb => cb.value),
                            aggressive: scrapeAggressive.checked
                        })
                    });
                    const data = await res.json();

                    if (data.status === 'success') {
                        lastScrapeResults = data.results;
                        renderOmniResults(data.results);
                    } else {
                        omniList.innerHTML = `<div style="color: #FF0055;">ERROR: ${data.error}</div>`;
                    }

                } catch (e) {
                    omniList.innerHTML = `<div style="color: #FF0055;">CONNECTION_FAIL: ${e.message}</div>`;
                } finally {
                    scrapeBtn.textContent = 'SCAN';
                    scrapeBtn.disabled = false;
                }
            });
        }

        function renderOmniResults(results) {
            omniList.innerHTML = '';
            if (results.length === 0) {
                omniList.innerHTML = '<div style="text-align: center; opacity: 0.5;">NO_VECTORS_FOUND</div>';
                return;
            }

            results.forEach((item, index) => {
                const el = document.createElement('div');
                el.style.cssText = "background: rgba(0, 255, 209, 0.05); padding: 8px; border: 1px solid rgba(0, 255, 209, 0.1);";

                let content = `<div style="font-weight: bold; color: #00FFD1; margin-bottom: 4px;">
                        <a href="${item.link}" target="_blank" style="color: #00FFD1; text-decoration: none;">${item.title}</a>
                    </div>`;

                if (item.snippet) {
                    content += `<div style="font-size: 11px; color: #ccc; margin-bottom: 4px;">${item.snippet}</div>`;
                }

                if (item.full_text) {
                    content += `<div style="font-size: 10px; color: #fff; background: rgba(0,0,0,0.3); padding: 4px; margin-top: 4px; border-left: 2px solid #00FFD1;">
                            <span style="color: #00FFD1;">[FULL_TEXT_EXTRACT]</span> ${item.full_text}
                        </div>`;
                }

                if (scrapeType.value === 'images' && item.link.match(/\.(jpeg|jpg|gif|png)$/) != null) {
                    content += `<img src="${item.link}" style="max-width: 100%; margin-top: 5px; border: 1px solid #333;">`;
                }

                if (scrapeType.value === 'videos') {
                    if (item.thumbnail) {
                        content += `<div style="position: relative; margin-top: 5px;">
                            <img src="${item.thumbnail}" style="width: 100%; border: 1px solid #333; opacity: 0.8;">
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 20px; text-shadow: 0 0 10px #000;">
                                <i class="fas fa-play-circle"></i>
                            </div>
                         </div>`;
                    }
                }

                el.innerHTML = content;
                omniList.appendChild(el);
            });
        }

        if (omniClose) omniClose.addEventListener('click', () => omniModal.style.display = 'none');

        if (omniMinimize) {
            omniMinimize.addEventListener('click', () => {
                isOmniMinimized = !isOmniMinimized;
                if (isOmniMinimized) {
                    omniList.style.display = 'none';
                    if (omniShare) omniShare.parentElement.style.display = 'none';
                    omniModal.style.height = 'auto';
                } else {
                    omniList.style.display = 'flex';
                    if (omniShare) omniShare.parentElement.style.display = 'block';
                    omniModal.style.height = 'auto';
                    omniModal.style.maxHeight = '80vh';
                }
            });
        }

        if (omniShare) {
            omniShare.addEventListener('click', () => {
                if (lastScrapeResults.length === 0) return;

                // Format for AI
                let summary = "ANALYZED SCAN DATA:\n";
                lastScrapeResults.slice(0, 5).forEach(item => {
                    summary += `- ${item.title}: ${item.snippet}\n`;
                    if (item.full_text) summary += `  EXTRACT: ${item.full_text.substring(0, 200)}...\n`;
                });

                // Open Chat if closed
                const modal = document.getElementById('geosentialai-modal');
                if (modal.style.display === 'none') modal.style.display = 'flex';

                const input = document.getElementById('geosentialai-input');
                // Auto-fill logic
                input.value = `Analyze this scan data:\n${summary}`;
                input.focus();
            });
        }

        // --- Toggle Logic for Search Bar ---
        const omniToggleBtn = document.getElementById('omni-search-toggle-btn');
        const scraperControl = document.getElementById('web-scraper-control');
        const omniCloseBar = document.getElementById('omni-close-bar');

        if (omniToggleBtn && scraperControl) {
            omniToggleBtn.addEventListener('click', () => {
                if (scraperControl.style.display === 'none' || !scraperControl.style.display) {
                    scraperControl.style.display = 'flex';
                } else {
                    scraperControl.style.display = 'none';
                }
            });
        }

        if (omniCloseBar && scraperControl) {
            omniCloseBar.addEventListener('click', () => {
                scraperControl.style.display = 'none';
            });
        }

        // --- Draggable Logic ---
        function makeDraggable(element, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            if (handle) {
                handle.onmousedown = dragMouseDown;
                handle.style.cursor = 'move';
            } else {
                element.onmousedown = dragMouseDown;
                element.style.cursor = 'move';
            }

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                // call a function whenever the cursor moves:
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // set the element's new position:
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
                element.style.transform = "none"; // Remove centering transform if dragged
            }

            function closeDragElement() {
                // stop moving when mouse button is released:
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // Apply drag to Scraper Control
        const scraperHeader = scraperControl.querySelector('div[style*="justify-content: space-between"]');
        if (scraperControl && scraperHeader) {
            makeDraggable(scraperControl, scraperHeader);
        }

        // Apply drag to Results Modal
        const omniResultHeader = omniModal.querySelector('div[style*="justify-content: space-between"]');
        if (omniModal && omniResultHeader) {
            makeDraggable(omniModal, omniResultHeader);
        }


        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Initial Status Check
        checkOllamaStatus();
    </script>

</body>

</html>
